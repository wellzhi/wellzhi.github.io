<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dockerfile编写指南 | wellzhi</title>
<meta name=keywords content="Dockerfile,Docker,命令,容器化,DevOps"><meta name=description content="Dockerfile是用于构建Docker镜像的文本文件，包含了一系列指令和参数。本文详细介绍了Dockerfile的编写方法，包括常用指令、最佳实践、多阶段构建以及实际应用场景等内容。"><meta name=author content="wellzhi"><link rel=canonical href=https://wellzhi.github.io/posts/tech/2010-08-08_dockerfile/><link crossorigin=anonymous href=/assets/css/stylesheet.b54291e20a5b433add2181af00208e3e72d99f37b405cd9f3ff373c992518ba6.css integrity="sha256-tUKR4gpbQzrdIYGvACCOPnLZnze0Bc2fP/NzyZJRi6Y=" rel="preload stylesheet" as=style><script crossorigin=anonymous src=/assets/js/mermaid.min.af2e2ae7d64e037e8a582c3ba35b128209a6f8350c3825cda07833979e0d827c.js></script><link rel=icon href=https://wellzhi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wellzhi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wellzhi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wellzhi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wellzhi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wellzhi.github.io/posts/tech/2010-08-08_dockerfile/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wellzhi.github.io/posts/tech/2010-08-08_dockerfile/"><meta property="og:site_name" content="wellzhi"><meta property="og:title" content="Dockerfile编写指南"><meta property="og:description" content="Dockerfile是用于构建Docker镜像的文本文件，包含了一系列指令和参数。本文详细介绍了Dockerfile的编写方法，包括常用指令、最佳实践、多阶段构建以及实际应用场景等内容。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2010-08-08T00:00:00+08:00"><meta property="article:modified_time" content="2010-08-08T00:00:00+08:00"><meta property="article:tag" content="Dockerfile"><meta property="article:tag" content="Docker"><meta property="article:tag" content="命令"><meta property="article:tag" content="容器化"><meta property="article:tag" content="DevOps"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dockerfile编写指南"><meta name=twitter:description content="Dockerfile是用于构建Docker镜像的文本文件，包含了一系列指令和参数。本文详细介绍了Dockerfile的编写方法，包括常用指令、最佳实践、多阶段构建以及实际应用场景等内容。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wellzhi.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Tech","item":"https://wellzhi.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"Dockerfile编写指南","item":"https://wellzhi.github.io/posts/tech/2010-08-08_dockerfile/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dockerfile编写指南","name":"Dockerfile编写指南","description":"Dockerfile是用于构建Docker镜像的文本文件，包含了一系列指令和参数。本文详细介绍了Dockerfile的编写方法，包括常用指令、最佳实践、多阶段构建以及实际应用场景等内容。","keywords":["Dockerfile","Docker","命令","容器化","DevOps"],"articleBody":"Dockerfile编写完全指南 1. 简介 Dockerfile是一个文本文件，包含了一系列指令和参数，用于自动化构建Docker镜像。通过Dockerfile，我们可以定义应用程序的运行环境、依赖项、配置文件等，实现应用程序的容器化部署。\n1.1 什么是Dockerfile Dockerfile是Docker用来构建镜像的构建文件，是由一系列命令和参数构成的脚本。这些命令应用于基础镜像并最终创建一个新的镜像。\n1.2 Dockerfile的优势 可重复性: 确保在不同环境中构建相同的镜像 版本控制: 可以像代码一样进行版本管理 自动化: 支持CI/CD流水线自动构建 透明性: 清晰地展示镜像的构建过程 可移植性: 在任何支持Docker的环境中都能运行 2. Dockerfile基本语法 2.1 基本结构 # 注释 FROM base_image MAINTAINER author_info RUN command COPY source destination WORKDIR /path EXPOSE port CMD [\"executable\", \"param1\", \"param2\"] 2.2 语法规则 每个指令都必须为大写字母且后面要跟随至少一个参数 指令按照从上到下，顺序执行 # 表示注释 每个指令都会创建一个新的镜像层，并对镜像进行提交 3. 常用指令详解 3.1 FROM指令 FROM指令用于指定基础镜像，是Dockerfile的第一个指令。\n# 使用官方Python镜像 FROM python:3.9-slim # 使用特定版本的Ubuntu FROM ubuntu:20.04 # 使用多阶段构建 FROM node:16 AS builder FROM nginx:alpine AS production 最佳实践：\n优先选择官方镜像 使用具体的版本标签而不是latest 选择最小化的基础镜像（如alpine版本） 3.2 RUN指令 RUN指令用于在镜像构建过程中执行命令。\n# Shell形式 RUN apt-get update \u0026\u0026 apt-get install -y \\ curl \\ vim \\ git \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # Exec形式 RUN [\"apt-get\", \"update\"] RUN [\"apt-get\", \"install\", \"-y\", \"curl\"] # 多个命令合并 RUN apt-get update \\ \u0026\u0026 apt-get install -y python3 python3-pip \\ \u0026\u0026 pip3 install --upgrade pip \\ \u0026\u0026 apt-get clean 最佳实践：\n合并多个RUN指令减少镜像层数 清理包管理器缓存 使用\\进行换行提高可读性 3.3 COPY和ADD指令 COPY指令 # 复制文件 COPY app.py /app/ # 复制目录 COPY ./src /app/src # 复制多个文件 COPY requirements.txt package.json /app/ # 设置文件权限 COPY --chown=user:group files* /app/ ADD指令 # ADD具有额外功能：自动解压缩 ADD archive.tar.gz /app/ # 从URL下载文件 ADD https://example.com/file.txt /app/ 最佳实践：\n优先使用COPY而不是ADD 只有需要自动解压缩或从URL下载时才使用ADD 使用.dockerignore文件排除不需要的文件 3.4 WORKDIR指令 # 设置工作目录 WORKDIR /app # 相对路径（基于当前WORKDIR） WORKDIR src # 绝对路径 WORKDIR /usr/local/app 最佳实践：\n使用绝对路径 避免使用RUN cd命令 3.5 EXPOSE指令 # 暴露单个端口 EXPOSE 80 # 暴露多个端口 EXPOSE 80 443 # 指定协议 EXPOSE 53/udp EXPOSE 80/tcp **注意：**EXPOSE指令只是声明端口，实际运行时需要使用-p参数映射端口。\n3.6 ENV指令 # 设置环境变量 ENV NODE_ENV=production ENV PATH=/app/bin:$PATH # 一次设置多个变量 ENV NODE_ENV=production \\ PORT=3000 \\ DEBUG=false 3.7 ARG指令 # 定义构建参数 ARG VERSION=latest ARG BUILD_DATE # 使用构建参数 FROM node:${VERSION} LABEL build_date=${BUILD_DATE} 构建时传递参数：\ndocker build --build-arg VERSION=16 --build-arg BUILD_DATE=$(date) . 3.8 CMD和ENTRYPOINT指令 CMD指令 # Exec形式（推荐） CMD [\"python\", \"app.py\"] # Shell形式 CMD python app.py # 作为ENTRYPOINT的默认参数 CMD [\"--help\"] ENTRYPOINT指令 # 设置容器启动命令 ENTRYPOINT [\"python\", \"app.py\"] # 结合CMD使用 ENTRYPOINT [\"python\", \"app.py\"] CMD [\"--port\", \"8080\"] 区别：\nCMD可以被docker run命令覆盖 ENTRYPOINT不会被覆盖，docker run的参数会作为参数传递给ENTRYPOINT 3.9 VOLUME指令 # 创建挂载点 VOLUME [\"/data\"] VOLUME [\"/var/log\", \"/var/db\"] # 单个目录 VOLUME /app/uploads 3.10 USER指令 # 创建用户 RUN groupadd -r appuser \u0026\u0026 useradd -r -g appuser appuser # 切换用户 USER appuser # 使用UID USER 1000 3.11 HEALTHCHECK指令 # 健康检查 HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\ CMD curl -f http://localhost:8080/health || exit 1 # 禁用健康检查 HEALTHCHECK NONE 3.12 LABEL指令 # 添加元数据 LABEL version=\"1.0\" LABEL description=\"This is a web application\" LABEL maintainer=\"developer@example.com\" # 多个标签 LABEL version=\"1.0\" \\ description=\"Web application\" \\ maintainer=\"developer@example.com\" 4. 实际应用示例 4.1 Python Web应用 # 使用官方Python运行时作为基础镜像 FROM python:3.9-slim # 设置工作目录 WORKDIR /app # 设置环境变量 ENV PYTHONDONTWRITEBYTECODE=1 \\ PYTHONUNBUFFERED=1 # 安装系统依赖 RUN apt-get update \\ \u0026\u0026 apt-get install -y --no-install-recommends \\ gcc \\ libc6-dev \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # 复制requirements文件 COPY requirements.txt . # 安装Python依赖 RUN pip install --no-cache-dir -r requirements.txt # 复制应用代码 COPY . . # 创建非root用户 RUN groupadd -r appuser \u0026\u0026 useradd -r -g appuser appuser RUN chown -R appuser:appuser /app USER appuser # 暴露端口 EXPOSE 8000 # 健康检查 HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \\ CMD curl -f http://localhost:8000/health || exit 1 # 启动命令 CMD [\"gunicorn\", \"--bind\", \"0.0.0.0:8000\", \"app:app\"] 4.2 Node.js应用 # 使用官方Node.js镜像 FROM node:16-alpine # 设置工作目录 WORKDIR /usr/src/app # 复制package文件 COPY package*.json ./ # 安装依赖 RUN npm ci --only=production \u0026\u0026 npm cache clean --force # 复制应用代码 COPY . . # 创建用户 RUN addgroup -g 1001 -S nodejs RUN adduser -S nextjs -u 1001 # 更改文件所有权 RUN chown -R nextjs:nodejs /usr/src/app USER nextjs # 暴露端口 EXPOSE 3000 # 启动应用 CMD [\"node\", \"server.js\"] 4.3 Java Spring Boot应用 # 多阶段构建 FROM maven:3.8.4-openjdk-11 AS builder WORKDIR /app COPY pom.xml . RUN mvn dependency:go-offline COPY src ./src RUN mvn clean package -DskipTests # 运行阶段 FROM openjdk:11-jre-slim WORKDIR /app # 创建用户 RUN groupadd -r spring \u0026\u0026 useradd -r -g spring spring # 复制jar文件 COPY --from=builder /app/target/*.jar app.jar # 更改所有权 RUN chown spring:spring app.jar USER spring # 暴露端口 EXPOSE 8080 # JVM参数优化 ENV JAVA_OPTS=\"-Xmx512m -Xms256m\" # 启动应用 ENTRYPOINT [\"sh\", \"-c\", \"java $JAVA_OPTS -jar app.jar\"] 4.4 静态网站（Nginx） # 构建阶段 FROM node:16-alpine AS builder WORKDIR /app COPY package*.json ./ RUN npm ci COPY . . RUN npm run build # 生产阶段 FROM nginx:alpine # 复制构建产物 COPY --from=builder /app/dist /usr/share/nginx/html # 复制nginx配置 COPY nginx.conf /etc/nginx/nginx.conf # 暴露端口 EXPOSE 80 # 启动nginx CMD [\"nginx\", \"-g\", \"daemon off;\"] 5. 多阶段构建 5.1 基本概念 多阶段构建允许在一个Dockerfile中使用多个FROM指令，每个FROM指令可以使用不同的基础镜像。\n5.2 优势 减小最终镜像大小 分离构建环境和运行环境 提高安全性 简化构建流程 5.3 实际示例 # 第一阶段：构建 FROM golang:1.19-alpine AS builder WORKDIR /app COPY go.mod go.sum ./ RUN go mod download COPY . . RUN CGO_ENABLED=0 GOOS=linux go build -o main . # 第二阶段：运行 FROM alpine:latest RUN apk --no-cache add ca-certificates WORKDIR /root/ # 只复制编译后的二进制文件 COPY --from=builder /app/main . EXPOSE 8080 CMD [\"./main\"] 5.4 命名构建阶段 # 命名构建阶段 FROM node:16 AS dependencies WORKDIR /app COPY package*.json ./ RUN npm install FROM node:16 AS builder WORKDIR /app COPY --from=dependencies /app/node_modules ./node_modules COPY . . RUN npm run build FROM nginx:alpine AS production COPY --from=builder /app/dist /usr/share/nginx/html 6. 最佳实践 6.1 镜像大小优化 # 使用alpine镜像 FROM node:16-alpine # 合并RUN指令 RUN apk add --no-cache \\ python3 \\ make \\ g++ \\ \u0026\u0026 npm install \\ \u0026\u0026 apk del make g++ # 清理缓存 RUN apt-get update \\ \u0026\u0026 apt-get install -y package \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # 使用.dockerignore # .dockerignore文件内容： # node_modules # .git # *.log # .DS_Store 6.2 安全最佳实践 # 使用非root用户 RUN groupadd -r appuser \u0026\u0026 useradd -r -g appuser appuser USER appuser # 最小权限原则 COPY --chown=appuser:appuser . /app # 使用具体版本 FROM node:16.14.2-alpine # 扫描漏洞 # 使用工具如Trivy、Clair等 6.3 构建缓存优化 # 先复制依赖文件 COPY package*.json ./ RUN npm install # 后复制源代码 COPY . . RUN npm run build 6.4 环境变量管理 # 使用ARG进行构建时配置 ARG NODE_ENV=production ENV NODE_ENV=$NODE_ENV # 敏感信息使用secrets # docker build --secret id=mypassword,src=./password.txt . RUN --mount=type=secret,id=mypassword \\ PASSWORD=$(cat /run/secrets/mypassword) \u0026\u0026 \\ echo \"Password: $PASSWORD\" 6.5 健康检查 # Web应用健康检查 HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\ CMD curl -f http://localhost:8080/health || exit 1 # 数据库健康检查 HEALTHCHECK --interval=30s --timeout=3s --retries=3 \\ CMD mysqladmin ping -h localhost || exit 1 7. 常见问题和解决方案 7.1 镜像层过多 **问题：**每个RUN指令都会创建新的镜像层\n解决方案：\n# 错误做法 RUN apt-get update RUN apt-get install -y curl RUN apt-get install -y vim RUN rm -rf /var/lib/apt/lists/* # 正确做法 RUN apt-get update \u0026\u0026 \\ apt-get install -y curl vim \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* 7.2 缓存失效 **问题：**代码变更导致依赖重新安装\n解决方案：\n# 先复制依赖文件 COPY requirements.txt . RUN pip install -r requirements.txt # 后复制源代码 COPY . . 7.3 时区问题 # 设置时区 ENV TZ=Asia/Shanghai RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \u0026\u0026 echo $TZ \u003e /etc/timezone 7.4 权限问题 # 确保文件权限正确 COPY --chown=appuser:appuser . /app RUN chmod +x /app/start.sh 8. 调试和测试 8.1 构建调试 # 查看构建过程 docker build --progress=plain --no-cache . # 构建到特定阶段 docker build --target builder . # 查看镜像历史 docker history image_name 8.2 运行时调试 # 交互式运行 docker run -it image_name /bin/bash # 覆盖入口点 docker run -it --entrypoint /bin/bash image_name # 查看容器日志 docker logs container_name 8.3 镜像分析 # 使用dive分析镜像层 dive image_name # 查看镜像大小 docker images --format \"table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}\" 9. CI/CD集成 9.1 GitHub Actions name: Build and Push Docker Image on: push: branches: [ main ] jobs: build: runs-on: ubuntu-latest steps: - uses: actions/checkout@v2 - name: Build Docker image run: docker build -t myapp:${{ github.sha }} . - name: Push to registry run: | echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin docker push myapp:${{ github.sha }} 9.2 GitLab CI stages: - build - test - deploy build: stage: build script: - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA . - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA 10. 高级技巧 10.1 BuildKit特性 # syntax=docker/dockerfile:1 FROM alpine # 使用缓存挂载 RUN --mount=type=cache,target=/var/cache/apk \\ apk add --update git # 使用secrets RUN --mount=type=secret,id=mypassword \\ cat /run/secrets/mypassword 10.2 条件构建 ARG ENVIRONMENT=production # 开发环境安装调试工具 RUN if [ \"$ENVIRONMENT\" = \"development\" ]; then \\ apt-get update \u0026\u0026 apt-get install -y vim curl; \\ fi 10.3 动态标签 ARG VERSION LABEL version=$VERSION LABEL build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ') 11. 性能优化 11.1 并行构建 # 使用BuildKit并行构建 # DOCKER_BUILDKIT=1 docker build . FROM alpine AS stage1 RUN sleep 10 FROM alpine AS stage2 RUN sleep 10 FROM alpine COPY --from=stage1 /etc/os-release /stage1-info COPY --from=stage2 /etc/os-release /stage2-info 11.2 镜像压缩 # 使用squash减少层数 docker build --squash -t myapp . # 使用multi-stage构建 # 只保留最终运行时需要的文件 12. 监控和日志 12.1 日志配置 # 确保日志输出到stdout/stderr RUN ln -sf /dev/stdout /var/log/nginx/access.log \\ \u0026\u0026 ln -sf /dev/stderr /var/log/nginx/error.log 12.2 监控集成 # 添加监控端点 EXPOSE 9090 HEALTHCHECK --interval=30s CMD curl -f http://localhost:9090/metrics 总结 Dockerfile是容器化应用的核心，掌握其编写技巧对于现代应用开发至关重要。\n关键要点： 基础指令掌握：熟练使用FROM、RUN、COPY、WORKDIR等基本指令 多阶段构建：有效减小镜像大小，分离构建和运行环境 安全实践：使用非root用户，最小权限原则 性能优化：合理利用缓存，减少镜像层数 最佳实践：遵循Docker官方推荐的编写规范 实际应用建议： 从简单开始：先编写基本的Dockerfile，逐步优化 版本控制：将Dockerfile纳入版本控制系统 自动化测试：在CI/CD流水线中集成镜像构建和测试 安全扫描：定期扫描镜像漏洞 监控优化：持续监控镜像大小和构建时间 ","wordCount":"1305","inLanguage":"en","datePublished":"2010-08-08T00:00:00+08:00","dateModified":"2010-08-08T00:00:00+08:00","author":[{"@type":"Person","name":"wellzhi"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://wellzhi.github.io/posts/tech/2010-08-08_dockerfile/"},"publisher":{"@type":"Organization","name":"wellzhi","logo":{"@type":"ImageObject","url":"https://wellzhi.github.io/favicon.ico"}}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wellzhi.github.io/ accesskey=h title="wellzhi (Alt + H)">wellzhi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wellzhi.github.io/ title=Home><span>Home</span></a></li><li><a href=https://wellzhi.github.io/posts/ title=Post><span>Post</span></a></li><li><a href=https://wellzhi.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://wellzhi.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://wellzhi.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://wellzhi.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wellzhi.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/tech/>Tech</a></div><h1 class="post-title entry-hint-parent">Dockerfile编写指南</h1></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#dockerfile%e7%bc%96%e5%86%99%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97 aria-label=Dockerfile编写完全指南>Dockerfile编写完全指南</a><ul><li><a href=#1-%e7%ae%80%e4%bb%8b aria-label="1. 简介">1. 简介</a><ul><li><a href=#11-%e4%bb%80%e4%b9%88%e6%98%afdockerfile aria-label="1.1 什么是Dockerfile">1.1 什么是Dockerfile</a></li><li><a href=#12-dockerfile%e7%9a%84%e4%bc%98%e5%8a%bf aria-label="1.2 Dockerfile的优势">1.2 Dockerfile的优势</a></li></ul></li><li><a href=#2-dockerfile%e5%9f%ba%e6%9c%ac%e8%af%ad%e6%b3%95 aria-label="2. Dockerfile基本语法">2. Dockerfile基本语法</a><ul><li><a href=#21-%e5%9f%ba%e6%9c%ac%e7%bb%93%e6%9e%84 aria-label="2.1 基本结构">2.1 基本结构</a></li><li><a href=#22-%e8%af%ad%e6%b3%95%e8%a7%84%e5%88%99 aria-label="2.2 语法规则">2.2 语法规则</a></li></ul></li><li><a href=#3-%e5%b8%b8%e7%94%a8%e6%8c%87%e4%bb%a4%e8%af%a6%e8%a7%a3 aria-label="3. 常用指令详解">3. 常用指令详解</a><ul><li><a href=#31-from%e6%8c%87%e4%bb%a4 aria-label="3.1 FROM指令">3.1 FROM指令</a></li><li><a href=#32-run%e6%8c%87%e4%bb%a4 aria-label="3.2 RUN指令">3.2 RUN指令</a></li><li><a href=#33-copy%e5%92%8cadd%e6%8c%87%e4%bb%a4 aria-label="3.3 COPY和ADD指令">3.3 COPY和ADD指令</a><ul><li><a href=#copy%e6%8c%87%e4%bb%a4 aria-label=COPY指令>COPY指令</a></li><li><a href=#add%e6%8c%87%e4%bb%a4 aria-label=ADD指令>ADD指令</a></li></ul></li><li><a href=#34-workdir%e6%8c%87%e4%bb%a4 aria-label="3.4 WORKDIR指令">3.4 WORKDIR指令</a></li><li><a href=#35-expose%e6%8c%87%e4%bb%a4 aria-label="3.5 EXPOSE指令">3.5 EXPOSE指令</a></li><li><a href=#36-env%e6%8c%87%e4%bb%a4 aria-label="3.6 ENV指令">3.6 ENV指令</a></li><li><a href=#37-arg%e6%8c%87%e4%bb%a4 aria-label="3.7 ARG指令">3.7 ARG指令</a></li><li><a href=#38-cmd%e5%92%8centrypoint%e6%8c%87%e4%bb%a4 aria-label="3.8 CMD和ENTRYPOINT指令">3.8 CMD和ENTRYPOINT指令</a><ul><li><a href=#cmd%e6%8c%87%e4%bb%a4 aria-label=CMD指令>CMD指令</a></li><li><a href=#entrypoint%e6%8c%87%e4%bb%a4 aria-label=ENTRYPOINT指令>ENTRYPOINT指令</a></li></ul></li><li><a href=#39-volume%e6%8c%87%e4%bb%a4 aria-label="3.9 VOLUME指令">3.9 VOLUME指令</a></li><li><a href=#310-user%e6%8c%87%e4%bb%a4 aria-label="3.10 USER指令">3.10 USER指令</a></li><li><a href=#311-healthcheck%e6%8c%87%e4%bb%a4 aria-label="3.11 HEALTHCHECK指令">3.11 HEALTHCHECK指令</a></li><li><a href=#312-label%e6%8c%87%e4%bb%a4 aria-label="3.12 LABEL指令">3.12 LABEL指令</a></li></ul></li><li><a href=#4-%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e7%a4%ba%e4%be%8b aria-label="4. 实际应用示例">4. 实际应用示例</a><ul><li><a href=#41-python-web%e5%ba%94%e7%94%a8 aria-label="4.1 Python Web应用">4.1 Python Web应用</a></li><li><a href=#42-nodejs%e5%ba%94%e7%94%a8 aria-label="4.2 Node.js应用">4.2 Node.js应用</a></li><li><a href=#43-java-spring-boot%e5%ba%94%e7%94%a8 aria-label="4.3 Java Spring Boot应用">4.3 Java Spring Boot应用</a></li><li><a href=#44-%e9%9d%99%e6%80%81%e7%bd%91%e7%ab%99nginx aria-label="4.4 静态网站（Nginx）">4.4 静态网站（Nginx）</a></li></ul></li><li><a href=#5-%e5%a4%9a%e9%98%b6%e6%ae%b5%e6%9e%84%e5%bb%ba aria-label="5. 多阶段构建">5. 多阶段构建</a><ul><li><a href=#51-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-label="5.1 基本概念">5.1 基本概念</a></li><li><a href=#52-%e4%bc%98%e5%8a%bf aria-label="5.2 优势">5.2 优势</a></li><li><a href=#53-%e5%ae%9e%e9%99%85%e7%a4%ba%e4%be%8b aria-label="5.3 实际示例">5.3 实际示例</a></li><li><a href=#54-%e5%91%bd%e5%90%8d%e6%9e%84%e5%bb%ba%e9%98%b6%e6%ae%b5 aria-label="5.4 命名构建阶段">5.4 命名构建阶段</a></li></ul></li><li><a href=#6-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="6. 最佳实践">6. 最佳实践</a><ul><li><a href=#61-%e9%95%9c%e5%83%8f%e5%a4%a7%e5%b0%8f%e4%bc%98%e5%8c%96 aria-label="6.1 镜像大小优化">6.1 镜像大小优化</a></li><li><a href=#62-%e5%ae%89%e5%85%a8%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="6.2 安全最佳实践">6.2 安全最佳实践</a></li><li><a href=#63-%e6%9e%84%e5%bb%ba%e7%bc%93%e5%ad%98%e4%bc%98%e5%8c%96 aria-label="6.3 构建缓存优化">6.3 构建缓存优化</a></li><li><a href=#64-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%ae%a1%e7%90%86 aria-label="6.4 环境变量管理">6.4 环境变量管理</a></li><li><a href=#65-%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5 aria-label="6.5 健康检查">6.5 健康检查</a></li></ul></li><li><a href=#7-%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e5%92%8c%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 aria-label="7. 常见问题和解决方案">7. 常见问题和解决方案</a><ul><li><a href=#71-%e9%95%9c%e5%83%8f%e5%b1%82%e8%bf%87%e5%a4%9a aria-label="7.1 镜像层过多">7.1 镜像层过多</a></li><li><a href=#72-%e7%bc%93%e5%ad%98%e5%a4%b1%e6%95%88 aria-label="7.2 缓存失效">7.2 缓存失效</a></li><li><a href=#73-%e6%97%b6%e5%8c%ba%e9%97%ae%e9%a2%98 aria-label="7.3 时区问题">7.3 时区问题</a></li><li><a href=#74-%e6%9d%83%e9%99%90%e9%97%ae%e9%a2%98 aria-label="7.4 权限问题">7.4 权限问题</a></li></ul></li><li><a href=#8-%e8%b0%83%e8%af%95%e5%92%8c%e6%b5%8b%e8%af%95 aria-label="8. 调试和测试">8. 调试和测试</a><ul><li><a href=#81-%e6%9e%84%e5%bb%ba%e8%b0%83%e8%af%95 aria-label="8.1 构建调试">8.1 构建调试</a></li><li><a href=#82-%e8%bf%90%e8%a1%8c%e6%97%b6%e8%b0%83%e8%af%95 aria-label="8.2 运行时调试">8.2 运行时调试</a></li><li><a href=#83-%e9%95%9c%e5%83%8f%e5%88%86%e6%9e%90 aria-label="8.3 镜像分析">8.3 镜像分析</a></li></ul></li><li><a href=#9-cicd%e9%9b%86%e6%88%90 aria-label="9. CI/CD集成">9. CI/CD集成</a><ul><li><a href=#91-github-actions aria-label="9.1 GitHub Actions">9.1 GitHub Actions</a></li><li><a href=#92-gitlab-ci aria-label="9.2 GitLab CI">9.2 GitLab CI</a></li></ul></li><li><a href=#10-%e9%ab%98%e7%ba%a7%e6%8a%80%e5%b7%a7 aria-label="10. 高级技巧">10. 高级技巧</a><ul><li><a href=#101-buildkit%e7%89%b9%e6%80%a7 aria-label="10.1 BuildKit特性">10.1 BuildKit特性</a></li><li><a href=#102-%e6%9d%a1%e4%bb%b6%e6%9e%84%e5%bb%ba aria-label="10.2 条件构建">10.2 条件构建</a></li><li><a href=#103-%e5%8a%a8%e6%80%81%e6%a0%87%e7%ad%be aria-label="10.3 动态标签">10.3 动态标签</a></li></ul></li><li><a href=#11-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label="11. 性能优化">11. 性能优化</a><ul><li><a href=#111-%e5%b9%b6%e8%a1%8c%e6%9e%84%e5%bb%ba aria-label="11.1 并行构建">11.1 并行构建</a></li><li><a href=#112-%e9%95%9c%e5%83%8f%e5%8e%8b%e7%bc%a9 aria-label="11.2 镜像压缩">11.2 镜像压缩</a></li></ul></li><li><a href=#12-%e7%9b%91%e6%8e%a7%e5%92%8c%e6%97%a5%e5%bf%97 aria-label="12. 监控和日志">12. 监控和日志</a><ul><li><a href=#121-%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae aria-label="12.1 日志配置">12.1 日志配置</a></li><li><a href=#122-%e7%9b%91%e6%8e%a7%e9%9b%86%e6%88%90 aria-label="12.2 监控集成">12.2 监控集成</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><ul><li><a href=#%e5%85%b3%e9%94%ae%e8%a6%81%e7%82%b9 aria-label=关键要点：>关键要点：</a></li><li><a href=#%e5%ae%9e%e9%99%85%e5%ba%94%e7%94%a8%e5%bb%ba%e8%ae%ae aria-label=实际应用建议：>实际应用建议：</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h1 id=dockerfile编写完全指南>Dockerfile编写完全指南<a hidden class=anchor aria-hidden=true href=#dockerfile编写完全指南>#</a></h1><h2 id=1-简介>1. 简介<a hidden class=anchor aria-hidden=true href=#1-简介>#</a></h2><p>Dockerfile是一个文本文件，包含了一系列指令和参数，用于自动化构建Docker镜像。通过Dockerfile，我们可以定义应用程序的运行环境、依赖项、配置文件等，实现应用程序的容器化部署。</p><h3 id=11-什么是dockerfile>1.1 什么是Dockerfile<a hidden class=anchor aria-hidden=true href=#11-什么是dockerfile>#</a></h3><p>Dockerfile是Docker用来构建镜像的构建文件，是由一系列命令和参数构成的脚本。这些命令应用于基础镜像并最终创建一个新的镜像。</p><h3 id=12-dockerfile的优势>1.2 Dockerfile的优势<a hidden class=anchor aria-hidden=true href=#12-dockerfile的优势>#</a></h3><ul><li><strong>可重复性</strong>: 确保在不同环境中构建相同的镜像</li><li><strong>版本控制</strong>: 可以像代码一样进行版本管理</li><li><strong>自动化</strong>: 支持CI/CD流水线自动构建</li><li><strong>透明性</strong>: 清晰地展示镜像的构建过程</li><li><strong>可移植性</strong>: 在任何支持Docker的环境中都能运行</li></ul><h2 id=2-dockerfile基本语法>2. Dockerfile基本语法<a hidden class=anchor aria-hidden=true href=#2-dockerfile基本语法>#</a></h2><h3 id=21-基本结构>2.1 基本结构<a hidden class=anchor aria-hidden=true href=#21-基本结构>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 注释</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> base_image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>MAINTAINER</span><span style=color:#e6db74> author_info</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> command<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> source destination<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /path</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> port</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;executable&#34;</span>, <span style=color:#e6db74>&#34;param1&#34;</span>, <span style=color:#e6db74>&#34;param2&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=22-语法规则>2.2 语法规则<a hidden class=anchor aria-hidden=true href=#22-语法规则>#</a></h3><ul><li>每个指令都必须为大写字母且后面要跟随至少一个参数</li><li>指令按照从上到下，顺序执行</li><li><code>#</code> 表示注释</li><li>每个指令都会创建一个新的镜像层，并对镜像进行提交</li></ul><h2 id=3-常用指令详解>3. 常用指令详解<a hidden class=anchor aria-hidden=true href=#3-常用指令详解>#</a></h2><h3 id=31-from指令>3.1 FROM指令<a hidden class=anchor aria-hidden=true href=#31-from指令>#</a></h3><p><code>FROM</code>指令用于指定基础镜像，是Dockerfile的第一个指令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用官方Python镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.9-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用特定版本的Ubuntu</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:20.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用多阶段构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> nginx:alpine AS production</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>最佳实践：</strong></p><ul><li>优先选择官方镜像</li><li>使用具体的版本标签而不是<code>latest</code></li><li>选择最小化的基础镜像（如alpine版本）</li></ul><h3 id=32-run指令>3.2 RUN指令<a hidden class=anchor aria-hidden=true href=#32-run指令>#</a></h3><p><code>RUN</code>指令用于在镜像构建过程中执行命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Shell形式</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    vim <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Exec形式</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;apt-get&#34;</span>, <span style=color:#e6db74>&#34;update&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;apt-get&#34;</span>, <span style=color:#e6db74>&#34;install&#34;</span>, <span style=color:#e6db74>&#34;-y&#34;</span>, <span style=color:#e6db74>&#34;curl&#34;</span><span style=color:#f92672>]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 多个命令合并</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y python3 python3-pip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> pip3 install --upgrade pip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get clean<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>最佳实践：</strong></p><ul><li>合并多个RUN指令减少镜像层数</li><li>清理包管理器缓存</li><li>使用<code>\</code>进行换行提高可读性</li></ul><h3 id=33-copy和add指令>3.3 COPY和ADD指令<a hidden class=anchor aria-hidden=true href=#33-copy和add指令>#</a></h3><h4 id=copy指令>COPY指令<a hidden class=anchor aria-hidden=true href=#copy指令>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 复制文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> app.py /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./src /app/src<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制多个文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt package.json /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 设置文件权限</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --chown<span style=color:#f92672>=</span>user:group files* /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h4 id=add指令>ADD指令<a hidden class=anchor aria-hidden=true href=#add指令>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># ADD具有额外功能：自动解压缩</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> archive.tar.gz /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 从URL下载文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> https://example.com/file.txt /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>最佳实践：</strong></p><ul><li>优先使用COPY而不是ADD</li><li>只有需要自动解压缩或从URL下载时才使用ADD</li><li>使用.dockerignore文件排除不需要的文件</li></ul><h3 id=34-workdir指令>3.4 WORKDIR指令<a hidden class=anchor aria-hidden=true href=#34-workdir指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 设置工作目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 相对路径（基于当前WORKDIR）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> src</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 绝对路径</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/local/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>最佳实践：</strong></p><ul><li>使用绝对路径</li><li>避免使用<code>RUN cd</code>命令</li></ul><h3 id=35-expose指令>3.5 EXPOSE指令<a hidden class=anchor aria-hidden=true href=#35-expose指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 暴露单个端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 80</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 暴露多个端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 80 443</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 指定协议</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 53/udp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 80/tcp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>**注意：**EXPOSE指令只是声明端口，实际运行时需要使用<code>-p</code>参数映射端口。</p><h3 id=36-env指令>3.6 ENV指令<a hidden class=anchor aria-hidden=true href=#36-env指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 设置环境变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> NODE_ENV<span style=color:#f92672>=</span>production
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENV</span> PATH<span style=color:#f92672>=</span>/app/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 一次设置多个变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> NODE_ENV<span style=color:#f92672>=</span>production <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>3000</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    DEBUG<span style=color:#f92672>=</span>false
</span></span></code></pre></div><h3 id=37-arg指令>3.7 ARG指令<a hidden class=anchor aria-hidden=true href=#37-arg指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 定义构建参数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> VERSION<span style=color:#f92672>=</span>latest
</span></span><span style=display:flex><span><span style=color:#66d9ef>ARG</span> BUILD_DATE<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用构建参数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:${VERSION}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> build_date<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>BUILD_DATE<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>构建时传递参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build --build-arg VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span> --build-arg BUILD_DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span> .
</span></span></code></pre></div><h3 id=38-cmd和entrypoint指令>3.8 CMD和ENTRYPOINT指令<a hidden class=anchor aria-hidden=true href=#38-cmd和entrypoint指令>#</a></h3><h4 id=cmd指令>CMD指令<a hidden class=anchor aria-hidden=true href=#cmd指令>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Exec形式（推荐）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Shell形式</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> python app.py<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 作为ENTRYPOINT的默认参数</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;--help&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h4 id=entrypoint指令>ENTRYPOINT指令<a hidden class=anchor aria-hidden=true href=#entrypoint指令>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 设置容器启动命令</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 结合CMD使用</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;python&#34;</span>, <span style=color:#e6db74>&#34;app.py&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;--port&#34;</span>, <span style=color:#e6db74>&#34;8080&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p><strong>区别：</strong></p><ul><li>CMD可以被docker run命令覆盖</li><li>ENTRYPOINT不会被覆盖，docker run的参数会作为参数传递给ENTRYPOINT</li></ul><h3 id=39-volume指令>3.9 VOLUME指令<a hidden class=anchor aria-hidden=true href=#39-volume指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 创建挂载点</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span> [<span style=color:#e6db74>&#34;/data&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span> [<span style=color:#e6db74>&#34;/var/log&#34;</span>, <span style=color:#e6db74>&#34;/var/db&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 单个目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span><span style=color:#e6db74> /app/uploads</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=310-user指令>3.10 USER指令<a hidden class=anchor aria-hidden=true href=#310-user指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 创建用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> groupadd -r appuser <span style=color:#f92672>&amp;&amp;</span> useradd -r -g appuser appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 切换用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用UID</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> 1000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=311-healthcheck指令>3.11 HEALTHCHECK指令<a hidden class=anchor aria-hidden=true href=#311-healthcheck指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 健康检查</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK --interval=30s --timeout=3s </span>--start-period<span style=color:#f92672>=</span>5s --retries<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CMD curl -f http://localhost:8080/health <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 禁用健康检查</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK</span> NONE<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=312-label指令>3.12 LABEL指令<a hidden class=anchor aria-hidden=true href=#312-label指令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 添加元数据</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;This is a web application&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;developer@example.com&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 多个标签</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Web application&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;developer@example.com&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=4-实际应用示例>4. 实际应用示例<a hidden class=anchor aria-hidden=true href=#4-实际应用示例>#</a></h2><h3 id=41-python-web应用>4.1 Python Web应用<a hidden class=anchor aria-hidden=true href=#41-python-web应用>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用官方Python运行时作为基础镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> python:3.9-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 设置工作目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 设置环境变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PYTHONDONTWRITEBYTECODE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PYTHONUNBUFFERED<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装系统依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        gcc <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        libc6-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制requirements文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 安装Python依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install --no-cache-dir -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制应用代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 创建非root用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> groupadd -r appuser <span style=color:#f92672>&amp;&amp;</span> useradd -r -g appuser appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown -R appuser:appuser /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 暴露端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 健康检查</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK --interval=30s --timeout=10s </span>--start-period<span style=color:#f92672>=</span>5s --retries<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CMD curl -f http://localhost:8000/health <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 启动命令</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;gunicorn&#34;</span>, <span style=color:#e6db74>&#34;--bind&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0:8000&#34;</span>, <span style=color:#e6db74>&#34;app:app&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=42-nodejs应用>4.2 Node.js应用<a hidden class=anchor aria-hidden=true href=#42-nodejs应用>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用官方Node.js镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 设置工作目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制package文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 安装依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm ci --only<span style=color:#f92672>=</span>production <span style=color:#f92672>&amp;&amp;</span> npm cache clean --force<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制应用代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 创建用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup -g <span style=color:#ae81ff>1001</span> -S nodejs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> adduser -S nextjs -u <span style=color:#ae81ff>1001</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 更改文件所有权</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown -R nextjs:nodejs /usr/src/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> nextjs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 暴露端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 3000</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 启动应用</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;server.js&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=43-java-spring-boot应用>4.3 Java Spring Boot应用<a hidden class=anchor aria-hidden=true href=#43-java-spring-boot应用>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 多阶段构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> maven:3.8.4-openjdk-11 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> pom.xml .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mvn dependency:go-offline<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> src ./src<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mvn clean package -DskipTests<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 运行阶段</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:11-jre-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 创建用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> groupadd -r spring <span style=color:#f92672>&amp;&amp;</span> useradd -r -g spring spring<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制jar文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/target/*.jar app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 更改所有权</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown spring:spring app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> spring</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 暴露端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># JVM参数优化</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> JAVA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-Xmx512m -Xms256m&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 启动应用</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;java $JAVA_OPTS -jar app.jar&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=44-静态网站nginx>4.4 静态网站（Nginx）<a hidden class=anchor aria-hidden=true href=#44-静态网站nginx>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 构建阶段</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16-alpine AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm ci<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm run build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 生产阶段</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> nginx:alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制构建产物</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/dist /usr/share/nginx/html<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 复制nginx配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> nginx.conf /etc/nginx/nginx.conf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 暴露端口</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 80</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 启动nginx</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;nginx&#34;</span>, <span style=color:#e6db74>&#34;-g&#34;</span>, <span style=color:#e6db74>&#34;daemon off;&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=5-多阶段构建>5. 多阶段构建<a hidden class=anchor aria-hidden=true href=#5-多阶段构建>#</a></h2><h3 id=51-基本概念>5.1 基本概念<a hidden class=anchor aria-hidden=true href=#51-基本概念>#</a></h3><p>多阶段构建允许在一个Dockerfile中使用多个FROM指令，每个FROM指令可以使用不同的基础镜像。</p><h3 id=52-优势>5.2 优势<a hidden class=anchor aria-hidden=true href=#52-优势>#</a></h3><ul><li>减小最终镜像大小</li><li>分离构建环境和运行环境</li><li>提高安全性</li><li>简化构建流程</li></ul><h3 id=53-实际示例>5.3 实际示例<a hidden class=anchor aria-hidden=true href=#53-实际示例>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 第一阶段：构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:1.19-alpine AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> go.mod go.sum ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod download<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> CGO_ENABLED<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> GOOS<span style=color:#f92672>=</span>linux go build -o main .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 第二阶段：运行</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk --no-cache add ca-certificates<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /root/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 只复制编译后的二进制文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/main .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;./main&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=54-命名构建阶段>5.4 命名构建阶段<a hidden class=anchor aria-hidden=true href=#54-命名构建阶段>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 命名构建阶段</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16 AS dependencies</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>dependencies /app/node_modules ./node_modules<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm run build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> nginx:alpine AS production</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/dist /usr/share/nginx/html<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=6-最佳实践>6. 最佳实践<a hidden class=anchor aria-hidden=true href=#6-最佳实践>#</a></h2><h3 id=61-镜像大小优化>6.1 镜像大小优化<a hidden class=anchor aria-hidden=true href=#61-镜像大小优化>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用alpine镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 合并RUN指令</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    python3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    g++ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> npm install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apk del make g++<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 清理缓存</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y package <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用.dockerignore</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># .dockerignore文件内容：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># node_modules</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># .git</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># *.log</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># .DS_Store</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=62-安全最佳实践>6.2 安全最佳实践<a hidden class=anchor aria-hidden=true href=#62-安全最佳实践>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用非root用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> groupadd -r appuser <span style=color:#f92672>&amp;&amp;</span> useradd -r -g appuser appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span><span style=color:#e6db74> appuser</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 最小权限原则</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --chown<span style=color:#f92672>=</span>appuser:appuser . /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用具体版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:16.14.2-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 扫描漏洞</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用工具如Trivy、Clair等</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=63-构建缓存优化>6.3 构建缓存优化<a hidden class=anchor aria-hidden=true href=#63-构建缓存优化>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 先复制依赖文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 后复制源代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm run build<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=64-环境变量管理>6.4 环境变量管理<a hidden class=anchor aria-hidden=true href=#64-环境变量管理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用ARG进行构建时配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> NODE_ENV<span style=color:#f92672>=</span>production
</span></span><span style=display:flex><span><span style=color:#66d9ef>ENV</span> NODE_ENV<span style=color:#f92672>=</span>$NODE_ENV<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 敏感信息使用secrets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --secret id=mypassword,src=./password.txt .</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>secret,id<span style=color:#f92672>=</span>mypassword <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /run/secrets/mypassword<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    echo <span style=color:#e6db74>&#34;Password: </span>$PASSWORD<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=65-健康检查>6.5 健康检查<a hidden class=anchor aria-hidden=true href=#65-健康检查>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Web应用健康检查</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK --interval=30s --timeout=3s </span>--start-period<span style=color:#f92672>=</span>5s --retries<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CMD curl -f http://localhost:8080/health <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 数据库健康检查</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>    </span><span style=color:#66d9ef>CMD</span> mysqladmin ping -h localhost <span style=color:#f92672>||</span> exit <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=7-常见问题和解决方案>7. 常见问题和解决方案<a hidden class=anchor aria-hidden=true href=#7-常见问题和解决方案>#</a></h2><h3 id=71-镜像层过多>7.1 镜像层过多<a hidden class=anchor aria-hidden=true href=#71-镜像层过多>#</a></h3><p>**问题：**每个RUN指令都会创建新的镜像层</p><p><strong>解决方案：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 错误做法</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install -y curl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install -y vim<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 正确做法</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y curl vim <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=72-缓存失效>7.2 缓存失效<a hidden class=anchor aria-hidden=true href=#72-缓存失效>#</a></h3><p>**问题：**代码变更导致依赖重新安装</p><p><strong>解决方案：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 先复制依赖文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> requirements.txt .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pip install -r requirements.txt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 后复制源代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=73-时区问题>7.3 时区问题<a hidden class=anchor aria-hidden=true href=#73-时区问题>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 设置时区</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> TZ<span style=color:#f92672>=</span>Asia/Shanghai<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -snf /usr/share/zoneinfo/$TZ /etc/localtime <span style=color:#f92672>&amp;&amp;</span> echo $TZ &gt; /etc/timezone<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=74-权限问题>7.4 权限问题<a hidden class=anchor aria-hidden=true href=#74-权限问题>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 确保文件权限正确</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --chown<span style=color:#f92672>=</span>appuser:appuser . /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /app/start.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=8-调试和测试>8. 调试和测试<a hidden class=anchor aria-hidden=true href=#8-调试和测试>#</a></h2><h3 id=81-构建调试>8.1 构建调试<a hidden class=anchor aria-hidden=true href=#81-构建调试>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看构建过程</span>
</span></span><span style=display:flex><span>docker build --progress<span style=color:#f92672>=</span>plain --no-cache .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 构建到特定阶段</span>
</span></span><span style=display:flex><span>docker build --target builder .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像历史</span>
</span></span><span style=display:flex><span>docker history image_name
</span></span></code></pre></div><h3 id=82-运行时调试>8.2 运行时调试<a hidden class=anchor aria-hidden=true href=#82-运行时调试>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 交互式运行</span>
</span></span><span style=display:flex><span>docker run -it image_name /bin/bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 覆盖入口点</span>
</span></span><span style=display:flex><span>docker run -it --entrypoint /bin/bash image_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看容器日志</span>
</span></span><span style=display:flex><span>docker logs container_name
</span></span></code></pre></div><h3 id=83-镜像分析>8.3 镜像分析<a hidden class=anchor aria-hidden=true href=#83-镜像分析>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用dive分析镜像层</span>
</span></span><span style=display:flex><span>dive image_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像大小</span>
</span></span><span style=display:flex><span>docker images --format <span style=color:#e6db74>&#34;table {{.Repository}}\t{{.Tag}}\t{{.Size}}&#34;</span>
</span></span></code></pre></div><h2 id=9-cicd集成>9. CI/CD集成<a hidden class=anchor aria-hidden=true href=#9-cicd集成>#</a></h2><h3 id=91-github-actions>9.1 GitHub Actions<a hidden class=anchor aria-hidden=true href=#91-github-actions>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build and Push Docker Image</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [ <span style=color:#ae81ff>main ]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build Docker image</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker build -t myapp:${{ github.sha }} .</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Push to registry</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        docker push myapp:${{ github.sha }}</span>
</span></span></code></pre></div><h3 id=92-gitlab-ci>9.2 GitLab CI<a hidden class=anchor aria-hidden=true href=#92-gitlab-ci>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span>
</span></span></code></pre></div><h2 id=10-高级技巧>10. 高级技巧<a hidden class=anchor aria-hidden=true href=#10-高级技巧>#</a></h2><h3 id=101-buildkit特性>10.1 BuildKit特性<a hidden class=anchor aria-hidden=true href=#101-buildkit特性>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># syntax=docker/dockerfile:1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用缓存挂载</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/var/cache/apk <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apk add --update git<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 使用secrets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>secret,id<span style=color:#f92672>=</span>mypassword <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cat /run/secrets/mypassword<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=102-条件构建>10.2 条件构建<a hidden class=anchor aria-hidden=true href=#102-条件构建>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> ENVIRONMENT<span style=color:#f92672>=</span>production
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开发环境安装调试工具</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$ENVIRONMENT<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;development&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y vim curl; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>fi</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=103-动态标签>10.3 动态标签<a hidden class=anchor aria-hidden=true href=#103-动态标签>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> VERSION<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> version<span style=color:#f92672>=</span>$VERSION<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> build_date<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date -u +<span style=color:#e6db74>&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span><span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=11-性能优化>11. 性能优化<a hidden class=anchor aria-hidden=true href=#11-性能优化>#</a></h2><h3 id=111-并行构建>11.1 并行构建<a hidden class=anchor aria-hidden=true href=#111-并行构建>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 使用BuildKit并行构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># DOCKER_BUILDKIT=1 docker build .</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine AS stage1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sleep <span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine AS stage2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sleep <span style=color:#ae81ff>10</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>stage1 /etc/os-release /stage1-info<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>stage2 /etc/os-release /stage2-info<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=112-镜像压缩>11.2 镜像压缩<a hidden class=anchor aria-hidden=true href=#112-镜像压缩>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用squash减少层数</span>
</span></span><span style=display:flex><span>docker build --squash -t myapp .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用multi-stage构建</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 只保留最终运行时需要的文件</span>
</span></span></code></pre></div><h2 id=12-监控和日志>12. 监控和日志<a hidden class=anchor aria-hidden=true href=#12-监控和日志>#</a></h2><h3 id=121-日志配置>12.1 日志配置<a hidden class=anchor aria-hidden=true href=#121-日志配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 确保日志输出到stdout/stderr</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -sf /dev/stdout /var/log/nginx/access.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -sf /dev/stderr /var/log/nginx/error.log<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=122-监控集成>12.2 监控集成<a hidden class=anchor aria-hidden=true href=#122-监控集成>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># 添加监控端点</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 9090</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>HEALTHCHECK --interval=30s </span><span style=color:#66d9ef>CMD</span> curl -f http://localhost:9090/metrics<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>Dockerfile是容器化应用的核心，掌握其编写技巧对于现代应用开发至关重要。</p><h3 id=关键要点>关键要点：<a hidden class=anchor aria-hidden=true href=#关键要点>#</a></h3><ol><li><strong>基础指令掌握</strong>：熟练使用FROM、RUN、COPY、WORKDIR等基本指令</li><li><strong>多阶段构建</strong>：有效减小镜像大小，分离构建和运行环境</li><li><strong>安全实践</strong>：使用非root用户，最小权限原则</li><li><strong>性能优化</strong>：合理利用缓存，减少镜像层数</li><li><strong>最佳实践</strong>：遵循Docker官方推荐的编写规范</li></ol><h3 id=实际应用建议>实际应用建议：<a hidden class=anchor aria-hidden=true href=#实际应用建议>#</a></h3><ol><li><strong>从简单开始</strong>：先编写基本的Dockerfile，逐步优化</li><li><strong>版本控制</strong>：将Dockerfile纳入版本控制系统</li><li><strong>自动化测试</strong>：在CI/CD流水线中集成镜像构建和测试</li><li><strong>安全扫描</strong>：定期扫描镜像漏洞</li><li><strong>监控优化</strong>：持续监控镜像大小和构建时间</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://wellzhi.github.io/tags/dockerfile/>Dockerfile</a></li><li><a href=https://wellzhi.github.io/tags/docker/>Docker</a></li><li><a href=https://wellzhi.github.io/tags/%E5%91%BD%E4%BB%A4/>命令</a></li><li><a href=https://wellzhi.github.io/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/>容器化</a></li><li><a href=https://wellzhi.github.io/tags/devops/>DevOps</a></li></ul></footer><div class=comments-section><div class=comments-header><h3 class=comments-title><svg class="comments-icon" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
评论区</h3><div class=comments-divider></div></div><div id=twikoo-loading class=twikoo-loading><div class=loading-spinner></div><p>评论加载中...</p></div><div id=twikoo class=twikoo-container></div><div id=twikoo-error class=twikoo-error style=display:none><div class=error-content><svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p>评论加载失败，请刷新页面重试</p></div></div></div><style>.comments-section{margin:3rem 0 2rem;padding:0;max-width:100%}.comments-header{margin-bottom:2rem}.comments-title{display:flex;align-items:center;gap:.5rem;font-size:1.5rem;font-weight:600;color:var(--primary,#1a1a1a);margin:0 0 1rem}.comments-icon{width:1.5rem;height:1.5rem;color:var(--theme,#007acc)}.comments-divider{height:2px;background:linear-gradient(90deg,var(--theme,#007acc) 0%,transparent 100%);border-radius:1px;width:60px}.twikoo-container{background:var(--code-bg,#f8f9fa);border-radius:12px;padding:1.5rem;border:1px solid var(--border,#e1e5e9);transition:all .3s ease;min-height:200px}.twikoo-container:hover{border-color:var(--theme,#007acc);box-shadow:0 4px 12px rgba(0,122,204,.1)}.twikoo-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 1rem;color:var(--secondary,#666)}.loading-spinner{width:32px;height:32px;border:3px solid var(--border,#e1e5e9);border-top:3px solid var(--theme,#007acc);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.twikoo-error{text-align:center;padding:2rem;color:var(--secondary,#666)}.error-content{display:flex;flex-direction:column;align-items:center;gap:1rem}.error-icon{width:2rem;height:2rem;color:#dc3545}@media(prefers-color-scheme:dark){.comments-title{color:var(--primary,#ffffff)}.twikoo-container{background:var(--code-bg,#2d3748);border-color:var(--border,#4a5568)}}@media(max-width:768px){.comments-section{margin:2rem 0 1rem}.twikoo-container{padding:1rem;border-radius:8px}.comments-title{font-size:1.25rem}}</style><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>(function(){const e=document.getElementById("twikoo-loading"),t=document.getElementById("twikoo-error"),n=document.getElementById("twikoo");twikoo.init({envId:"https://twikoo-vercel-navy.vercel.app/",el:"#twikoo",onCommentLoaded:function(){e&&(e.style.display="none")}}).then(function(){e&&(e.style.display="none")}).catch(function(n){console.error("Twikoo 初始化失败:",n),e&&(e.style.display="none"),t&&(t.style.display="block")}),setTimeout(function(){e&&e.style.display!=="none"&&(e.style.display="none",t&&(t.style.display="block"))},5e3)})()</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wellzhi.github.io/>wellzhi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),theme=""):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),theme="dark"),mermaidTextContents.forEach((e,t)=>{document.getElementsByClassName("language-mermaid")[t].removeAttribute("data-processed"),document.getElementsByClassName("language-mermaid")[t].innerHTML=e}),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>localStorage.getItem("pref-theme")=="dark"?theme="dark":theme="",mermaidTextContents=Array.from(document.getElementsByClassName("language-mermaid")).map(e=>e.innerHTML),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")</script></body></html>