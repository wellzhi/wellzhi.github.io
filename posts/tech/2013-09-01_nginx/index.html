<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Nginx 配置 | wellzhi</title>
<meta name=keywords content="nginx"><meta name=description content="Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。"><meta name=author content="wellzhi"><link rel=canonical href=https://wellzhi.github.io/posts/tech/2013-09-01_nginx/><link crossorigin=anonymous href=/assets/css/stylesheet.b54291e20a5b433add2181af00208e3e72d99f37b405cd9f3ff373c992518ba6.css integrity="sha256-tUKR4gpbQzrdIYGvACCOPnLZnze0Bc2fP/NzyZJRi6Y=" rel="preload stylesheet" as=style><script crossorigin=anonymous src=/assets/js/mermaid.min.af2e2ae7d64e037e8a582c3ba35b128209a6f8350c3825cda07833979e0d827c.js></script><link rel=icon href=https://wellzhi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wellzhi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wellzhi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wellzhi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wellzhi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wellzhi.github.io/posts/tech/2013-09-01_nginx/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wellzhi.github.io/posts/tech/2013-09-01_nginx/"><meta property="og:site_name" content="wellzhi"><meta property="og:title" content="Nginx 配置"><meta property="og:description" content="Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-09-01T00:00:00-08:00"><meta property="article:modified_time" content="2013-09-01T00:00:00-08:00"><meta property="article:tag" content="Nginx"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nginx 配置"><meta name=twitter:description content="Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wellzhi.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Tech","item":"https://wellzhi.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"Nginx 配置","item":"https://wellzhi.github.io/posts/tech/2013-09-01_nginx/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx 配置","name":"Nginx 配置","description":"Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。","keywords":["nginx"],"articleBody":"1. Nginx 简介 Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。\n1.1 主要特性 高并发处理能力 低内存消耗 高可靠性 热部署 负载均衡 反向代理 静态文件服务 SSL/TLS支持 2. 安装 Nginx 2.1 Ubuntu/Debian 系统 # 更新包列表 sudo apt update # 安装nginx sudo apt install nginx # 启动nginx sudo systemctl start nginx # 设置开机自启 sudo systemctl enable nginx 2.2 CentOS/RHEL 系统 # 安装EPEL仓库 sudo yum install epel-release # 安装nginx sudo yum install nginx # 启动nginx sudo systemctl start nginx # 设置开机自启 sudo systemctl enable nginx 2.3 macOS 系统 # 使用Homebrew安装 brew install nginx # 启动nginx brew services start nginx 2.4 编译安装 # 下载源码 wget http://nginx.org/download/nginx-1.24.0.tar.gz tar -zxvf nginx-1.24.0.tar.gz cd nginx-1.24.0 # 配置编译选项 ./configure --prefix=/etc/nginx \\ --sbin-path=/usr/sbin/nginx \\ --conf-path=/etc/nginx/nginx.conf \\ --error-log-path=/var/log/nginx/error.log \\ --http-log-path=/var/log/nginx/access.log \\ --pid-path=/var/run/nginx.pid \\ --lock-path=/var/run/nginx.lock \\ --with-http_ssl_module \\ --with-http_realip_module \\ --with-http_gzip_static_module # 编译安装 make \u0026\u0026 sudo make install 3. Nginx 目录结构 3.1 主要目录 /etc/nginx/ # 主配置目录 ├── nginx.conf # 主配置文件 ├── conf.d/ # 额外配置文件目录 ├── sites-available/ # 可用站点配置 ├── sites-enabled/ # 启用站点配置 ├── snippets/ # 配置片段 └── modules-enabled/ # 启用的模块 /var/log/nginx/ # 日志目录 ├── access.log # 访问日志 └── error.log # 错误日志 /var/www/html/ # 默认网站根目录 /usr/share/nginx/html/ # 默认页面目录 4. 基础配置 4.1 主配置文件结构 # /etc/nginx/nginx.conf # 全局块 user nginx; worker_processes auto; error_log /var/log/nginx/error.log; pid /run/nginx.pid; # events块 events { worker_connections 1024; use epoll; multi_accept on; } # http块 http { # 基础设置 include /etc/nginx/mime.types; default_type application/octet-stream; # 日志格式 log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; # 性能优化 sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; # Gzip压缩 gzip on; gzip_vary on; gzip_min_length 1024; gzip_types text/plain text/css application/json application/javascript text/xml application/xml; # 包含其他配置文件 include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } 4.2 虚拟主机配置 # /etc/nginx/sites-available/example.com server { listen 80; listen [::]:80; server_name example.com www.example.com; root /var/www/example.com/html; index index.html index.htm index.nginx-debian.html; # 访问日志 access_log /var/log/nginx/example.com.access.log; error_log /var/log/nginx/example.com.error.log; # 静态文件处理 location / { try_files $uri $uri/ =404; } # 静态资源缓存 location ~* \\.(jpg|jpeg|png|gif|ico|css|js)$ { expires 1y; add_header Cache-Control \"public, immutable\"; } # 安全设置 location ~ /\\. { deny all; } } 5. 反向代理配置 5.1 基本反向代理 server { listen 80; server_name api.example.com; location / { proxy_pass http://127.0.0.1:3000; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; # 超时设置 proxy_connect_timeout 30s; proxy_send_timeout 30s; proxy_read_timeout 30s; } } 5.2 负载均衡 # 定义上游服务器组 upstream backend { # 轮询（默认） server 192.168.1.10:8080; server 192.168.1.11:8080; server 192.168.1.12:8080; # 权重负载均衡 # server 192.168.1.10:8080 weight=3; # server 192.168.1.11:8080 weight=2; # server 192.168.1.12:8080 weight=1; # IP哈希 # ip_hash; # 最少连接 # least_conn; # 健康检查 server 192.168.1.10:8080 max_fails=3 fail_timeout=30s; } server { listen 80; server_name app.example.com; location / { proxy_pass http://backend; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } 6. SSL/HTTPS 配置 6.1 SSL 证书配置 server { listen 443 ssl http2; listen [::]:443 ssl http2; server_name example.com www.example.com; # SSL证书配置 ssl_certificate /etc/ssl/certs/example.com.crt; ssl_certificate_key /etc/ssl/private/example.com.key; # SSL安全配置 ssl_protocols TLSv1.2 TLSv1.3; ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384; ssl_prefer_server_ciphers off; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; # HSTS add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always; # 其他安全头 add_header X-Frame-Options DENY; add_header X-Content-Type-Options nosniff; add_header X-XSS-Protection \"1; mode=block\"; root /var/www/example.com/html; index index.html; location / { try_files $uri $uri/ =404; } } # HTTP重定向到HTTPS server { listen 80; listen [::]:80; server_name example.com www.example.com; return 301 https://$server_name$request_uri; } 6.2 Let’s Encrypt 免费证书 # 安装certbot sudo apt install certbot python3-certbot-nginx # 获取证书 sudo certbot --nginx -d example.com -d www.example.com # 自动续期 sudo crontab -e # 添加以下行 0 12 * * * /usr/bin/certbot renew --quiet 7. 性能优化 7.1 工作进程优化 # 设置工作进程数（通常等于CPU核心数） worker_processes auto; # 绑定工作进程到CPU核心 worker_cpu_affinity auto; # 工作进程连接数 events { worker_connections 2048; use epoll; multi_accept on; } 7.2 缓存配置 http { # 文件缓存 open_file_cache max=1000 inactive=20s; open_file_cache_valid 30s; open_file_cache_min_uses 2; open_file_cache_errors on; # 代理缓存 proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m use_temp_path=off; server { location / { proxy_cache my_cache; proxy_cache_valid 200 302 10m; proxy_cache_valid 404 1m; proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504; proxy_cache_lock on; proxy_pass http://backend; } } } 7.3 压缩优化 # Gzip压缩 gzip on; gzip_vary on; gzip_min_length 1024; gzip_comp_level 6; gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml; # Brotli压缩（需要安装模块） # brotli on; # brotli_comp_level 6; # brotli_types text/plain text/css application/json application/javascript text/xml application/xml; 8. 安全配置 8.1 基础安全设置 # 隐藏Nginx版本 server_tokens off; # 限制请求大小 client_max_body_size 10M; # 限制请求速率 http { limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s; limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s; server { # 登录接口限流 location /login { limit_req zone=login burst=5 nodelay; proxy_pass http://backend; } # API接口限流 location /api/ { limit_req zone=api burst=20 nodelay; proxy_pass http://backend; } } } 8.2 防止恶意访问 # 阻止特定User-Agent if ($http_user_agent ~* (bot|crawler|spider)) { return 403; } # 阻止特定IP deny 192.168.1.100; allow 192.168.1.0/24; deny all; # 防止SQL注入和XSS if ($args ~* \"(union|select|insert|delete|update|drop|script|alert)\") { return 403; } # 防止目录遍历 location ~ /\\. { deny all; access_log off; log_not_found off; } # 防止访问敏感文件 location ~* \\.(htaccess|htpasswd|ini|log|sh|sql|conf)$ { deny all; } 9. 日志管理 9.1 自定义日志格式 http { # 详细日志格式 log_format detailed '$remote_addr - $remote_user [$time_local] ' '\"$request\" $status $body_bytes_sent ' '\"$http_referer\" \"$http_user_agent\" ' '$request_time $upstream_response_time ' '$pipe $upstream_cache_status'; # JSON格式日志 log_format json escape=json '{' '\"time_local\":\"$time_local\",' '\"remote_addr\":\"$remote_addr\",' '\"request\":\"$request\",' '\"status\":$status,' '\"body_bytes_sent\":$body_bytes_sent,' '\"http_referer\":\"$http_referer\",' '\"http_user_agent\":\"$http_user_agent\",' '\"request_time\":$request_time' '}'; access_log /var/log/nginx/access.log detailed; } 9.2 日志轮转 # /etc/logrotate.d/nginx /var/log/nginx/*.log { daily missingok rotate 52 compress delaycompress notifempty create 644 nginx adm postrotate if [ -f /var/run/nginx.pid ]; then kill -USR1 `cat /var/run/nginx.pid` fi endscript } 10. 常用命令 10.1 服务管理 # 启动nginx sudo systemctl start nginx # 停止nginx sudo systemctl stop nginx # 重启nginx sudo systemctl restart nginx # 重新加载配置 sudo systemctl reload nginx # 查看状态 sudo systemctl status nginx # 测试配置文件 sudo nginx -t # 查看配置文件路径 nginx -T # 查看版本信息 nginx -v nginx -V 10.2 信号控制 # 优雅停止 sudo nginx -s quit # 快速停止 sudo nginx -s stop # 重新加载配置 sudo nginx -s reload # 重新打开日志文件 sudo nginx -s reopen 11. 故障排查 11.1 常见错误及解决方案 11.1.1 403 Forbidden # 检查文件权限 ls -la /var/www/html/ # 修改权限 sudo chown -R nginx:nginx /var/www/html/ sudo chmod -R 755 /var/www/html/ # 检查SELinux（CentOS/RHEL） sudo setsebool -P httpd_can_network_connect 1 11.1.2 502 Bad Gateway # 检查后端服务是否运行 netstat -tlnp | grep :3000 # 检查防火墙 sudo ufw status sudo firewall-cmd --list-all # 检查nginx错误日志 sudo tail -f /var/log/nginx/error.log 11.1.3 504 Gateway Timeout # 增加超时时间 location / { proxy_connect_timeout 60s; proxy_send_timeout 60s; proxy_read_timeout 60s; proxy_pass http://backend; } 11.2 性能监控 # 查看连接状态 ss -tuln | grep :80 # 监控nginx进程 top -p $(pgrep nginx) # 查看访问统计 awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10 # 分析响应时间 awk '{print $NF}' /var/log/nginx/access.log | sort -n | tail -10 12. 高级配置 12.1 动态模块加载 # 加载模块 load_module modules/ngx_http_geoip_module.so; http { # 使用GeoIP geoip_country /usr/share/GeoIP/GeoIP.dat; map $geoip_country_code $allowed_country { default no; CN yes; US yes; } server { if ($allowed_country = no) { return 403; } } } 12.2 Lua脚本集成 # 需要安装lua模块 location /api { access_by_lua_block { local headers = ngx.req.get_headers() if not headers[\"authorization\"] then ngx.status = 401 ngx.say(\"Unauthorized\") ngx.exit(401) end } proxy_pass http://backend; } 12.3 实时配置更新 # 使用nginx-plus的API location /api { api write=on; allow 127.0.0.1; deny all; } # 动态添加上游服务器 # curl -X POST -d '{\"server\":\"192.168.1.100:8080\"}' \\ # http://localhost/api/6/http/upstreams/backend/servers 13. 最佳实践 13.1 配置文件组织 /etc/nginx/ ├── nginx.conf # 主配置文件 ├── conf.d/ │ ├── gzip.conf # 压缩配置 │ ├── security.conf # 安全配置 │ └── ssl.conf # SSL配置 ├── sites-available/ │ ├── example.com # 站点配置 │ └── api.example.com # API配置 └── sites-enabled/ # 启用的站点（软链接） 13.2 配置模板 # /etc/nginx/conf.d/security.conf # 安全头配置 add_header X-Frame-Options DENY always; add_header X-Content-Type-Options nosniff always; add_header X-XSS-Protection \"1; mode=block\" always; add_header Referrer-Policy \"strict-origin-when-cross-origin\" always; # 隐藏服务器信息 server_tokens off; more_clear_headers Server; 13.3 监控和告警 #!/bin/bash # nginx_monitor.sh # 检查nginx状态 if ! systemctl is-active --quiet nginx; then echo \"Nginx is down!\" | mail -s \"Nginx Alert\" admin@example.com fi # 检查错误日志 error_count=$(tail -100 /var/log/nginx/error.log | grep \"$(date '+%Y/%m/%d')\" | wc -l) if [ $error_count -gt 10 ]; then echo \"High error rate: $error_count errors today\" | mail -s \"Nginx Error Alert\" admin@example.com fi ","wordCount":"1251","inLanguage":"en","datePublished":"2013-09-01T00:00:00-08:00","dateModified":"2013-09-01T00:00:00-08:00","author":{"@type":"Person","name":"wellzhi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wellzhi.github.io/posts/tech/2013-09-01_nginx/"},"publisher":{"@type":"Organization","name":"wellzhi","logo":{"@type":"ImageObject","url":"https://wellzhi.github.io/favicon.ico"}}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wellzhi.github.io/ accesskey=h title="wellzhi (Alt + H)">wellzhi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wellzhi.github.io/ title=Home><span>Home</span></a></li><li><a href=https://wellzhi.github.io/posts/ title=Post><span>Post</span></a></li><li><a href=https://wellzhi.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://wellzhi.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://wellzhi.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://wellzhi.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wellzhi.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/tech/>Tech</a></div><h1 class="post-title entry-hint-parent">Nginx 配置</h1></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-nginx-%e7%ae%80%e4%bb%8b aria-label="1. Nginx 简介">1. Nginx 简介</a><ul><li><a href=#11-%e4%b8%bb%e8%a6%81%e7%89%b9%e6%80%a7 aria-label="1.1 主要特性">1.1 主要特性</a></li></ul></li><li><a href=#2-%e5%ae%89%e8%a3%85-nginx aria-label="2. 安装 Nginx">2. 安装 Nginx</a><ul><li><a href=#21-ubuntudebian-%e7%b3%bb%e7%bb%9f aria-label="2.1 Ubuntu/Debian 系统">2.1 Ubuntu/Debian 系统</a></li><li><a href=#22-centosrhel-%e7%b3%bb%e7%bb%9f aria-label="2.2 CentOS/RHEL 系统">2.2 CentOS/RHEL 系统</a></li><li><a href=#23-macos-%e7%b3%bb%e7%bb%9f aria-label="2.3 macOS 系统">2.3 macOS 系统</a></li><li><a href=#24-%e7%bc%96%e8%af%91%e5%ae%89%e8%a3%85 aria-label="2.4 编译安装">2.4 编译安装</a></li></ul></li><li><a href=#3-nginx-%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label="3. Nginx 目录结构">3. Nginx 目录结构</a><ul><li><a href=#31-%e4%b8%bb%e8%a6%81%e7%9b%ae%e5%bd%95 aria-label="3.1 主要目录">3.1 主要目录</a></li></ul></li><li><a href=#4-%e5%9f%ba%e7%a1%80%e9%85%8d%e7%bd%ae aria-label="4. 基础配置">4. 基础配置</a><ul><li><a href=#41-%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84 aria-label="4.1 主配置文件结构">4.1 主配置文件结构</a></li><li><a href=#42-%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba%e9%85%8d%e7%bd%ae aria-label="4.2 虚拟主机配置">4.2 虚拟主机配置</a></li></ul></li><li><a href=#5-%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86%e9%85%8d%e7%bd%ae aria-label="5. 反向代理配置">5. 反向代理配置</a><ul><li><a href=#51-%e5%9f%ba%e6%9c%ac%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86 aria-label="5.1 基本反向代理">5.1 基本反向代理</a></li><li><a href=#52-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 aria-label="5.2 负载均衡">5.2 负载均衡</a></li></ul></li><li><a href=#6-sslhttps-%e9%85%8d%e7%bd%ae aria-label="6. SSL/HTTPS 配置">6. SSL/HTTPS 配置</a><ul><li><a href=#61-ssl-%e8%af%81%e4%b9%a6%e9%85%8d%e7%bd%ae aria-label="6.1 SSL 证书配置">6.1 SSL 证书配置</a></li><li><a href=#62-lets-encrypt-%e5%85%8d%e8%b4%b9%e8%af%81%e4%b9%a6 aria-label="6.2 Let&rsquo;s Encrypt 免费证书">6.2 Let&rsquo;s Encrypt 免费证书</a></li></ul></li><li><a href=#7-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96 aria-label="7. 性能优化">7. 性能优化</a><ul><li><a href=#71-%e5%b7%a5%e4%bd%9c%e8%bf%9b%e7%a8%8b%e4%bc%98%e5%8c%96 aria-label="7.1 工作进程优化">7.1 工作进程优化</a></li><li><a href=#72-%e7%bc%93%e5%ad%98%e9%85%8d%e7%bd%ae aria-label="7.2 缓存配置">7.2 缓存配置</a></li><li><a href=#73-%e5%8e%8b%e7%bc%a9%e4%bc%98%e5%8c%96 aria-label="7.3 压缩优化">7.3 压缩优化</a></li></ul></li><li><a href=#8-%e5%ae%89%e5%85%a8%e9%85%8d%e7%bd%ae aria-label="8. 安全配置">8. 安全配置</a><ul><li><a href=#81-%e5%9f%ba%e7%a1%80%e5%ae%89%e5%85%a8%e8%ae%be%e7%bd%ae aria-label="8.1 基础安全设置">8.1 基础安全设置</a></li><li><a href=#82-%e9%98%b2%e6%ad%a2%e6%81%b6%e6%84%8f%e8%ae%bf%e9%97%ae aria-label="8.2 防止恶意访问">8.2 防止恶意访问</a></li></ul></li><li><a href=#9-%e6%97%a5%e5%bf%97%e7%ae%a1%e7%90%86 aria-label="9. 日志管理">9. 日志管理</a><ul><li><a href=#91-%e8%87%aa%e5%ae%9a%e4%b9%89%e6%97%a5%e5%bf%97%e6%a0%bc%e5%bc%8f aria-label="9.1 自定义日志格式">9.1 自定义日志格式</a></li><li><a href=#92-%e6%97%a5%e5%bf%97%e8%bd%ae%e8%bd%ac aria-label="9.2 日志轮转">9.2 日志轮转</a></li></ul></li><li><a href=#10-%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label="10. 常用命令">10. 常用命令</a><ul><li><a href=#101-%e6%9c%8d%e5%8a%a1%e7%ae%a1%e7%90%86 aria-label="10.1 服务管理">10.1 服务管理</a></li><li><a href=#102-%e4%bf%a1%e5%8f%b7%e6%8e%a7%e5%88%b6 aria-label="10.2 信号控制">10.2 信号控制</a></li></ul></li><li><a href=#11-%e6%95%85%e9%9a%9c%e6%8e%92%e6%9f%a5 aria-label="11. 故障排查">11. 故障排查</a><ul><li><a href=#111-%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af%e5%8f%8a%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 aria-label="11.1 常见错误及解决方案">11.1 常见错误及解决方案</a><ul><li><a href=#1111-403-forbidden aria-label="11.1.1 403 Forbidden">11.1.1 403 Forbidden</a></li><li><a href=#1112-502-bad-gateway aria-label="11.1.2 502 Bad Gateway">11.1.2 502 Bad Gateway</a></li><li><a href=#1113-504-gateway-timeout aria-label="11.1.3 504 Gateway Timeout">11.1.3 504 Gateway Timeout</a></li></ul></li><li><a href=#112-%e6%80%a7%e8%83%bd%e7%9b%91%e6%8e%a7 aria-label="11.2 性能监控">11.2 性能监控</a></li></ul></li><li><a href=#12-%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae aria-label="12. 高级配置">12. 高级配置</a><ul><li><a href=#121-%e5%8a%a8%e6%80%81%e6%a8%a1%e5%9d%97%e5%8a%a0%e8%bd%bd aria-label="12.1 动态模块加载">12.1 动态模块加载</a></li><li><a href=#122-lua%e8%84%9a%e6%9c%ac%e9%9b%86%e6%88%90 aria-label="12.2 Lua脚本集成">12.2 Lua脚本集成</a></li><li><a href=#123-%e5%ae%9e%e6%97%b6%e9%85%8d%e7%bd%ae%e6%9b%b4%e6%96%b0 aria-label="12.3 实时配置更新">12.3 实时配置更新</a></li></ul></li><li><a href=#13-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="13. 最佳实践">13. 最佳实践</a><ul><li><a href=#131-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%bb%84%e7%bb%87 aria-label="13.1 配置文件组织">13.1 配置文件组织</a></li><li><a href=#132-%e9%85%8d%e7%bd%ae%e6%a8%a1%e6%9d%bf aria-label="13.2 配置模板">13.2 配置模板</a></li><li><a href=#133-%e7%9b%91%e6%8e%a7%e5%92%8c%e5%91%8a%e8%ad%a6 aria-label="13.3 监控和告警">13.3 监控和告警</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=1-nginx-简介>1. Nginx 简介<a hidden class=anchor aria-hidden=true href=#1-nginx-简介>#</a></h2><p>Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。以其高性能、稳定性、丰富的功能集、简单的配置文件和低系统资源消耗而闻名。</p><h3 id=11-主要特性>1.1 主要特性<a hidden class=anchor aria-hidden=true href=#11-主要特性>#</a></h3><ul><li>高并发处理能力</li><li>低内存消耗</li><li>高可靠性</li><li>热部署</li><li>负载均衡</li><li>反向代理</li><li>静态文件服务</li><li>SSL/TLS支持</li></ul><h2 id=2-安装-nginx>2. 安装 Nginx<a hidden class=anchor aria-hidden=true href=#2-安装-nginx>#</a></h2><h3 id=21-ubuntudebian-系统>2.1 Ubuntu/Debian 系统<a hidden class=anchor aria-hidden=true href=#21-ubuntudebian-系统>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 更新包列表</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装nginx</span>
</span></span><span style=display:flex><span>sudo apt install nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动nginx</span>
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置开机自启</span>
</span></span><span style=display:flex><span>sudo systemctl enable nginx
</span></span></code></pre></div><h3 id=22-centosrhel-系统>2.2 CentOS/RHEL 系统<a hidden class=anchor aria-hidden=true href=#22-centosrhel-系统>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装EPEL仓库</span>
</span></span><span style=display:flex><span>sudo yum install epel-release
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装nginx</span>
</span></span><span style=display:flex><span>sudo yum install nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动nginx</span>
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置开机自启</span>
</span></span><span style=display:flex><span>sudo systemctl enable nginx
</span></span></code></pre></div><h3 id=23-macos-系统>2.3 macOS 系统<a hidden class=anchor aria-hidden=true href=#23-macos-系统>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用Homebrew安装</span>
</span></span><span style=display:flex><span>brew install nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动nginx</span>
</span></span><span style=display:flex><span>brew services start nginx
</span></span></code></pre></div><h3 id=24-编译安装>2.4 编译安装<a hidden class=anchor aria-hidden=true href=#24-编译安装>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 下载源码</span>
</span></span><span style=display:flex><span>wget http://nginx.org/download/nginx-1.24.0.tar.gz
</span></span><span style=display:flex><span>tar -zxvf nginx-1.24.0.tar.gz
</span></span><span style=display:flex><span>cd nginx-1.24.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置编译选项</span>
</span></span><span style=display:flex><span>./configure --prefix<span style=color:#f92672>=</span>/etc/nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --sbin-path<span style=color:#f92672>=</span>/usr/sbin/nginx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --conf-path<span style=color:#f92672>=</span>/etc/nginx/nginx.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --error-log-path<span style=color:#f92672>=</span>/var/log/nginx/error.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --http-log-path<span style=color:#f92672>=</span>/var/log/nginx/access.log <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --pid-path<span style=color:#f92672>=</span>/var/run/nginx.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --lock-path<span style=color:#f92672>=</span>/var/run/nginx.lock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --with-http_ssl_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --with-http_realip_module <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --with-http_gzip_static_module
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 编译安装</span>
</span></span><span style=display:flex><span>make <span style=color:#f92672>&amp;&amp;</span> sudo make install
</span></span></code></pre></div><h2 id=3-nginx-目录结构>3. Nginx 目录结构<a hidden class=anchor aria-hidden=true href=#3-nginx-目录结构>#</a></h2><h3 id=31-主要目录>3.1 主要目录<a hidden class=anchor aria-hidden=true href=#31-主要目录>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/etc/nginx/                 <span style=color:#75715e># 主配置目录</span>
</span></span><span style=display:flex><span>├── nginx.conf             <span style=color:#75715e># 主配置文件</span>
</span></span><span style=display:flex><span>├── conf.d/                <span style=color:#75715e># 额外配置文件目录</span>
</span></span><span style=display:flex><span>├── sites-available/       <span style=color:#75715e># 可用站点配置</span>
</span></span><span style=display:flex><span>├── sites-enabled/         <span style=color:#75715e># 启用站点配置</span>
</span></span><span style=display:flex><span>├── snippets/              <span style=color:#75715e># 配置片段</span>
</span></span><span style=display:flex><span>└── modules-enabled/       <span style=color:#75715e># 启用的模块</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/var/log/nginx/            <span style=color:#75715e># 日志目录</span>
</span></span><span style=display:flex><span>├── access.log             <span style=color:#75715e># 访问日志</span>
</span></span><span style=display:flex><span>└── error.log              <span style=color:#75715e># 错误日志</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/var/www/html/             <span style=color:#75715e># 默认网站根目录</span>
</span></span><span style=display:flex><span>/usr/share/nginx/html/     <span style=color:#75715e># 默认页面目录</span>
</span></span></code></pre></div><h2 id=4-基础配置>4. 基础配置<a hidden class=anchor aria-hidden=true href=#4-基础配置>#</a></h2><h3 id=41-主配置文件结构>4.1 主配置文件结构<a hidden class=anchor aria-hidden=true href=#41-主配置文件结构>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># /etc/nginx/nginx.conf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># 全局块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>user</span> <span style=color:#e6db74>nginx</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>worker_processes</span> <span style=color:#e6db74>auto</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>error_log</span> <span style=color:#e6db74>/var/log/nginx/error.log</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>pid</span> <span style=color:#e6db74>/run/nginx.pid</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># events块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker_connections</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>use</span> <span style=color:#e6db74>epoll</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>multi_accept</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># http块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 基础设置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>include</span>       <span style=color:#e6db74>/etc/nginx/mime.types</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>default_type</span>  <span style=color:#e6db74>application/octet-stream</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 日志格式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>log_format</span> <span style=color:#e6db74>main</span> <span style=color:#e6db74>&#39;</span>$remote_addr <span style=color:#e6db74>-</span> $remote_user <span style=color:#e6db74>[</span>$time_local] <span style=color:#e6db74>&#34;</span>$request&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;</span>$status $body_bytes_sent <span style=color:#e6db74>&#34;</span>$http_referer&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;&#34;</span>$http_user_agent&#34; <span style=color:#e6db74>&#34;</span>$http_x_forwarded_for&#34;&#39;;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/access.log</span> <span style=color:#e6db74>main</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 性能优化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>sendfile</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>tcp_nopush</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>tcp_nodelay</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>keepalive_timeout</span> <span style=color:#ae81ff>65</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>types_hash_max_size</span> <span style=color:#ae81ff>2048</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># Gzip压缩
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>gzip</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip_vary</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip_min_length</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>gzip_types</span> <span style=color:#e6db74>text/plain</span> <span style=color:#e6db74>text/css</span> <span style=color:#e6db74>application/json</span> <span style=color:#e6db74>application/javascript</span> <span style=color:#e6db74>text/xml</span> <span style=color:#e6db74>application/xml</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 包含其他配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>include</span> <span style=color:#e6db74>/etc/nginx/conf.d/*.conf</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>include</span> <span style=color:#e6db74>/etc/nginx/sites-enabled/*</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=42-虚拟主机配置>4.2 虚拟主机配置<a hidden class=anchor aria-hidden=true href=#42-虚拟主机配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># /etc/nginx/sites-available/example.com
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example.com/html</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span> <span style=color:#e6db74>index.htm</span> <span style=color:#e6db74>index.nginx-debian.html</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 访问日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/example.com.access.log</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/example.com.error.log</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 静态文件处理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 静态资源缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.(jpg|jpeg|png|gif|ico|css|js)</span>$ {
</span></span><span style=display:flex><span>        <span style=color:#f92672>expires</span> <span style=color:#e6db74>1y</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Cache-Control</span> <span style=color:#e6db74>&#34;public,</span> <span style=color:#e6db74>immutable&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 安全设置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>/\.</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=5-反向代理配置>5. 反向代理配置<a hidden class=anchor aria-hidden=true href=#5-反向代理配置>#</a></h2><h3 id=51-基本反向代理>5.1 基本反向代理<a hidden class=anchor aria-hidden=true href=#51-基本反向代理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>api.example.com</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:3000</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-Proto</span> $scheme;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 超时设置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>proxy_connect_timeout</span> <span style=color:#e6db74>30s</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_send_timeout</span> <span style=color:#e6db74>30s</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_read_timeout</span> <span style=color:#e6db74>30s</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=52-负载均衡>5.2 负载均衡<a hidden class=anchor aria-hidden=true href=#52-负载均衡>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 定义上游服务器组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>upstream</span> <span style=color:#e6db74>backend</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 轮询（默认）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>server</span> 192.168.1.10:<span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> 192.168.1.11:<span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> 192.168.1.12:<span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 权重负载均衡
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e># server 192.168.1.10:8080 weight=3;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e># server 192.168.1.11:8080 weight=2;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e># server 192.168.1.12:8080 weight=1;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># IP哈希
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e># ip_hash;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 最少连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e># least_conn;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 健康检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>server</span> 192.168.1.10:<span style=color:#ae81ff>8080</span> <span style=color:#e6db74>max_fails=3</span> <span style=color:#e6db74>fail_timeout=30s</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>app.example.com</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=6-sslhttps-配置>6. SSL/HTTPS 配置<a hidden class=anchor aria-hidden=true href=#6-sslhttps-配置>#</a></h2><h3 id=61-ssl-证书配置>6.1 SSL 证书配置<a hidden class=anchor aria-hidden=true href=#61-ssl-证书配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>443</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:443</span> <span style=color:#e6db74>ssl</span> <span style=color:#e6db74>http2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># SSL证书配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>ssl_certificate</span> <span style=color:#e6db74>/etc/ssl/certs/example.com.crt</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_certificate_key</span> <span style=color:#e6db74>/etc/ssl/private/example.com.key</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># SSL安全配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>ssl_protocols</span> <span style=color:#e6db74>TLSv1.2</span> <span style=color:#e6db74>TLSv1.3</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_ciphers</span> <span style=color:#e6db74>ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_prefer_server_ciphers</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_cache</span> <span style=color:#e6db74>shared:SSL:10m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssl_session_timeout</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># HSTS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Strict-Transport-Security</span> <span style=color:#e6db74>&#34;max-age=31536000</span>; <span style=color:#f92672>includeSubDomains&#34;</span> <span style=color:#e6db74>always</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 其他安全头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>X-Frame-Options</span> <span style=color:#e6db74>DENY</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>X-Content-Type-Options</span> <span style=color:#e6db74>nosniff</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>X-XSS-Protection</span> <span style=color:#e6db74>&#34;1</span>; <span style=color:#f92672>mode=block&#34;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/example.com/html</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span> <span style=color:#e6db74>index.html</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>try_files</span> $uri $uri/ =<span style=color:#ae81ff>404</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HTTP重定向到HTTPS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#e6db74>[::]:80</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span> <span style=color:#e6db74>www.example.com</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> <span style=color:#e6db74>https://</span>$server_name$request_uri;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=62-lets-encrypt-免费证书>6.2 Let&rsquo;s Encrypt 免费证书<a hidden class=anchor aria-hidden=true href=#62-lets-encrypt-免费证书>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装certbot</span>
</span></span><span style=display:flex><span>sudo apt install certbot python3-certbot-nginx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取证书</span>
</span></span><span style=display:flex><span>sudo certbot --nginx -d example.com -d www.example.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 自动续期</span>
</span></span><span style=display:flex><span>sudo crontab -e
</span></span><span style=display:flex><span><span style=color:#75715e># 添加以下行</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>12</span> * * * /usr/bin/certbot renew --quiet
</span></span></code></pre></div><h2 id=7-性能优化>7. 性能优化<a hidden class=anchor aria-hidden=true href=#7-性能优化>#</a></h2><h3 id=71-工作进程优化>7.1 工作进程优化<a hidden class=anchor aria-hidden=true href=#71-工作进程优化>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 设置工作进程数（通常等于CPU核心数）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>worker_processes</span> <span style=color:#e6db74>auto</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 绑定工作进程到CPU核心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>worker_cpu_affinity</span> <span style=color:#e6db74>auto</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 工作进程连接数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker_connections</span> <span style=color:#ae81ff>2048</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>use</span> <span style=color:#e6db74>epoll</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>multi_accept</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=72-缓存配置>7.2 缓存配置<a hidden class=anchor aria-hidden=true href=#72-缓存配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 文件缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>open_file_cache</span> <span style=color:#e6db74>max=1000</span> <span style=color:#e6db74>inactive=20s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>open_file_cache_valid</span> <span style=color:#e6db74>30s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>open_file_cache_min_uses</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>open_file_cache_errors</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 代理缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache_path</span> <span style=color:#e6db74>/var/cache/nginx</span> <span style=color:#e6db74>levels=1:2</span> <span style=color:#e6db74>keys_zone=my_cache:10m</span> <span style=color:#e6db74>max_size=10g</span> 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>inactive=60m</span> <span style=color:#e6db74>use_temp_path=off</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>my_cache</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>302</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>404</span> <span style=color:#ae81ff>1m</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_use_stale</span> <span style=color:#e6db74>error</span> <span style=color:#e6db74>timeout</span> <span style=color:#e6db74>updating</span> <span style=color:#e6db74>http_500</span> <span style=color:#e6db74>http_502</span> <span style=color:#e6db74>http_503</span> <span style=color:#e6db74>http_504</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_lock</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=73-压缩优化>7.3 压缩优化<a hidden class=anchor aria-hidden=true href=#73-压缩优化>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># Gzip压缩
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>gzip</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>gzip_vary</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>gzip_min_length</span> <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>gzip_comp_level</span> <span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>gzip_types</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>text/plain</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>text/css</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>text/xml</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>text/javascript</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>application/json</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>application/javascript</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>application/xml+rss</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>application/atom+xml</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>image/svg+xml</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Brotli压缩（需要安装模块）
</span></span></span><span style=display:flex><span><span style=color:#75715e># brotli on;
</span></span></span><span style=display:flex><span><span style=color:#75715e># brotli_comp_level 6;
</span></span></span><span style=display:flex><span><span style=color:#75715e># brotli_types text/plain text/css application/json application/javascript text/xml application/xml;
</span></span></span></code></pre></div><h2 id=8-安全配置>8. 安全配置<a hidden class=anchor aria-hidden=true href=#8-安全配置>#</a></h2><h3 id=81-基础安全设置>8.1 基础安全设置<a hidden class=anchor aria-hidden=true href=#81-基础安全设置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 隐藏Nginx版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>server_tokens</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 限制请求大小
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>client_max_body_size</span> <span style=color:#e6db74>10M</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 限制请求速率
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>limit_req_zone</span> $binary_remote_addr <span style=color:#e6db74>zone=login:10m</span> <span style=color:#e6db74>rate=1r/s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>limit_req_zone</span> $binary_remote_addr <span style=color:#e6db74>zone=api:10m</span> <span style=color:#e6db74>rate=10r/s</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># 登录接口限流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/login</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>limit_req</span> <span style=color:#e6db74>zone=login</span> <span style=color:#e6db74>burst=5</span> <span style=color:#e6db74>nodelay</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># API接口限流
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/api/</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>limit_req</span> <span style=color:#e6db74>zone=api</span> <span style=color:#e6db74>burst=20</span> <span style=color:#e6db74>nodelay</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=82-防止恶意访问>8.2 防止恶意访问<a hidden class=anchor aria-hidden=true href=#82-防止恶意访问>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 阻止特定User-Agent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#e6db74>(</span>$http_user_agent ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>(bot|crawler|spider))</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>403</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 阻止特定IP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>deny</span> 192.168.1.100;
</span></span><span style=display:flex><span><span style=color:#66d9ef>allow</span> 192.168.1.0<span style=color:#e6db74>/24</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防止SQL注入和XSS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#e6db74>(</span>$args ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>&#34;(union|select|insert|delete|update|drop|script|alert)&#34;)</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>return</span> <span style=color:#ae81ff>403</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防止目录遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> ~ <span style=color:#e6db74>/\.</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 防止访问敏感文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.(htaccess|htpasswd|ini|log|sh|sql|conf)</span>$ {
</span></span><span style=display:flex><span>    <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=9-日志管理>9. 日志管理<a hidden class=anchor aria-hidden=true href=#9-日志管理>#</a></h2><h3 id=91-自定义日志格式>9.1 自定义日志格式<a hidden class=anchor aria-hidden=true href=#91-自定义日志格式>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 详细日志格式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>log_format</span> <span style=color:#e6db74>detailed</span> <span style=color:#e6db74>&#39;</span>$remote_addr <span style=color:#e6db74>-</span> $remote_user <span style=color:#e6db74>[</span>$time_local] <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#39;&#34;</span>$request&#34; $status $body_bytes_sent <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#39;&#34;</span>$http_referer&#34; <span style=color:#e6db74>&#34;</span>$http_user_agent&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#39;</span>$request_time $upstream_response_time <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#39;</span>$pipe $upstream_cache_status&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># JSON格式日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>log_format</span> <span style=color:#e6db74>json</span> <span style=color:#e6db74>escape=json</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;</span>{<span style=color:#f92672>&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;time_local&#34;:&#34;</span>$time_local&#34;,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;remote_addr&#34;:&#34;</span>$remote_addr&#34;,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;request&#34;:&#34;</span>$request&#34;,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;status&#34;:</span>$status,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;body_bytes_sent&#34;:</span>$body_bytes_sent,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;http_referer&#34;:&#34;</span>$http_referer&#34;,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;http_user_agent&#34;:&#34;</span>$http_user_agent&#34;,&#39;
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;&#34;request_time&#34;:</span>$request_time&#39;
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;</span><span style=color:#960050;background-color:#1e0010>}</span><span style=color:#e6db74>&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/access.log</span> <span style=color:#e6db74>detailed</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=92-日志轮转>9.2 日志轮转<a hidden class=anchor aria-hidden=true href=#92-日志轮转>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># /etc/logrotate.d/nginx</span>
</span></span><span style=display:flex><span>/var/log/nginx/*.log <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    daily
</span></span><span style=display:flex><span>    missingok
</span></span><span style=display:flex><span>    rotate <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span>    compress
</span></span><span style=display:flex><span>    delaycompress
</span></span><span style=display:flex><span>    notifempty
</span></span><span style=display:flex><span>    create <span style=color:#ae81ff>644</span> nginx adm
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f /var/run/nginx.pid <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            kill -USR1 <span style=color:#e6db74>`</span>cat /var/run/nginx.pid<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=10-常用命令>10. 常用命令<a hidden class=anchor aria-hidden=true href=#10-常用命令>#</a></h2><h3 id=101-服务管理>10.1 服务管理<a hidden class=anchor aria-hidden=true href=#101-服务管理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 启动nginx</span>
</span></span><span style=display:flex><span>sudo systemctl start nginx
</span></span><span style=display:flex><span><span style=color:#75715e># 停止nginx</span>
</span></span><span style=display:flex><span>sudo systemctl stop nginx
</span></span><span style=display:flex><span><span style=color:#75715e># 重启nginx</span>
</span></span><span style=display:flex><span>sudo systemctl restart nginx
</span></span><span style=display:flex><span><span style=color:#75715e># 重新加载配置</span>
</span></span><span style=display:flex><span>sudo systemctl reload nginx
</span></span><span style=display:flex><span><span style=color:#75715e># 查看状态</span>
</span></span><span style=display:flex><span>sudo systemctl status nginx
</span></span><span style=display:flex><span><span style=color:#75715e># 测试配置文件</span>
</span></span><span style=display:flex><span>sudo nginx -t
</span></span><span style=display:flex><span><span style=color:#75715e># 查看配置文件路径</span>
</span></span><span style=display:flex><span>nginx -T
</span></span><span style=display:flex><span><span style=color:#75715e># 查看版本信息</span>
</span></span><span style=display:flex><span>nginx -v
</span></span><span style=display:flex><span>nginx -V
</span></span></code></pre></div><h3 id=102-信号控制>10.2 信号控制<a hidden class=anchor aria-hidden=true href=#102-信号控制>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 优雅停止</span>
</span></span><span style=display:flex><span>sudo nginx -s quit
</span></span><span style=display:flex><span><span style=color:#75715e># 快速停止</span>
</span></span><span style=display:flex><span>sudo nginx -s stop
</span></span><span style=display:flex><span><span style=color:#75715e># 重新加载配置</span>
</span></span><span style=display:flex><span>sudo nginx -s reload
</span></span><span style=display:flex><span><span style=color:#75715e># 重新打开日志文件</span>
</span></span><span style=display:flex><span>sudo nginx -s reopen
</span></span></code></pre></div><h2 id=11-故障排查>11. 故障排查<a hidden class=anchor aria-hidden=true href=#11-故障排查>#</a></h2><h3 id=111-常见错误及解决方案>11.1 常见错误及解决方案<a hidden class=anchor aria-hidden=true href=#111-常见错误及解决方案>#</a></h3><h4 id=1111-403-forbidden>11.1.1 403 Forbidden<a hidden class=anchor aria-hidden=true href=#1111-403-forbidden>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查文件权限</span>
</span></span><span style=display:flex><span>ls -la /var/www/html/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改权限</span>
</span></span><span style=display:flex><span>sudo chown -R nginx:nginx /var/www/html/
</span></span><span style=display:flex><span>sudo chmod -R <span style=color:#ae81ff>755</span> /var/www/html/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查SELinux（CentOS/RHEL）</span>
</span></span><span style=display:flex><span>sudo setsebool -P httpd_can_network_connect <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h4 id=1112-502-bad-gateway>11.1.2 502 Bad Gateway<a hidden class=anchor aria-hidden=true href=#1112-502-bad-gateway>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查后端服务是否运行</span>
</span></span><span style=display:flex><span>netstat -tlnp | grep :3000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查防火墙</span>
</span></span><span style=display:flex><span>sudo ufw status
</span></span><span style=display:flex><span>sudo firewall-cmd --list-all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查nginx错误日志</span>
</span></span><span style=display:flex><span>sudo tail -f /var/log/nginx/error.log
</span></span></code></pre></div><h4 id=1113-504-gateway-timeout>11.1.3 504 Gateway Timeout<a hidden class=anchor aria-hidden=true href=#1113-504-gateway-timeout>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 增加超时时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_connect_timeout</span> <span style=color:#e6db74>60s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_send_timeout</span> <span style=color:#e6db74>60s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_read_timeout</span> <span style=color:#e6db74>60s</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=112-性能监控>11.2 性能监控<a hidden class=anchor aria-hidden=true href=#112-性能监控>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看连接状态</span>
</span></span><span style=display:flex><span>ss -tuln | grep :80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 监控nginx进程</span>
</span></span><span style=display:flex><span>top -p <span style=color:#66d9ef>$(</span>pgrep nginx<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看访问统计</span>
</span></span><span style=display:flex><span>awk <span style=color:#e6db74>&#39;{print $1}&#39;</span> /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分析响应时间</span>
</span></span><span style=display:flex><span>awk <span style=color:#e6db74>&#39;{print $NF}&#39;</span> /var/log/nginx/access.log | sort -n | tail -10
</span></span></code></pre></div><h2 id=12-高级配置>12. 高级配置<a hidden class=anchor aria-hidden=true href=#12-高级配置>#</a></h2><h3 id=121-动态模块加载>12.1 动态模块加载<a hidden class=anchor aria-hidden=true href=#121-动态模块加载>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 加载模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>load_module</span> <span style=color:#e6db74>modules/ngx_http_geoip_module.so</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 使用GeoIP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>geoip_country</span> <span style=color:#e6db74>/usr/share/GeoIP/GeoIP.dat</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>map</span> $geoip_country_code $allowed_country {
</span></span><span style=display:flex><span>        <span style=color:#f92672>default</span> <span style=color:#e6db74>no</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>CN</span> <span style=color:#e6db74>yes</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>US</span> <span style=color:#e6db74>yes</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$allowed_country = <span style=color:#e6db74>no)</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>return</span> <span style=color:#ae81ff>403</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=122-lua脚本集成>12.2 Lua脚本集成<a hidden class=anchor aria-hidden=true href=#122-lua脚本集成>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 需要安装lua模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/api</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_by_lua_block</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>local</span> <span style=color:#e6db74>headers</span> = <span style=color:#e6db74>ngx.req.get_headers()</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>headers[&#34;authorization&#34;]</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.status</span> = <span style=color:#ae81ff>401</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(&#34;Unauthorized&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.exit(401)</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#e6db74>proxy_pass</span> <span style=color:#e6db74>http://backend</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=123-实时配置更新>12.3 实时配置更新<a hidden class=anchor aria-hidden=true href=#123-实时配置更新>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># 使用nginx-plus的API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>location</span> <span style=color:#e6db74>/api</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>api</span> <span style=color:#e6db74>write=on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>allow</span> 127.0.0.1;
</span></span><span style=display:flex><span>    <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 动态添加上游服务器
</span></span></span><span style=display:flex><span><span style=color:#75715e># curl -X POST -d &#39;{&#34;server&#34;:&#34;192.168.1.100:8080&#34;}&#39; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>#      http://localhost/api/6/http/upstreams/backend/servers
</span></span></span></code></pre></div><h2 id=13-最佳实践>13. 最佳实践<a hidden class=anchor aria-hidden=true href=#13-最佳实践>#</a></h2><h3 id=131-配置文件组织>13.1 配置文件组织<a hidden class=anchor aria-hidden=true href=#131-配置文件组织>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>/etc/nginx/</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>├──</span> <span style=color:#e6db74>nginx.conf</span>             <span style=color:#75715e># 主配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>├──</span> <span style=color:#e6db74>conf.d/</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>│</span>   <span style=color:#e6db74>├──</span> <span style=color:#e6db74>gzip.conf</span>          <span style=color:#75715e># 压缩配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>│</span>   <span style=color:#e6db74>├──</span> <span style=color:#e6db74>security.conf</span>      <span style=color:#75715e># 安全配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>│</span>   <span style=color:#e6db74>└──</span> <span style=color:#e6db74>ssl.conf</span>           <span style=color:#75715e># SSL配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>├──</span> <span style=color:#e6db74>sites-available/</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>│</span>   <span style=color:#e6db74>├──</span> <span style=color:#e6db74>example.com</span>        <span style=color:#75715e># 站点配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>│</span>   <span style=color:#e6db74>└──</span> <span style=color:#e6db74>api.example.com</span>    <span style=color:#75715e># API配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>└──</span> <span style=color:#e6db74>sites-enabled/</span>         <span style=color:#75715e># 启用的站点（软链接）
</span></span></span></code></pre></div><h3 id=132-配置模板>13.2 配置模板<a hidden class=anchor aria-hidden=true href=#132-配置模板>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#75715e># /etc/nginx/conf.d/security.conf
</span></span></span><span style=display:flex><span><span style=color:#75715e># 安全头配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>X-Frame-Options</span> <span style=color:#e6db74>DENY</span> <span style=color:#e6db74>always</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>X-Content-Type-Options</span> <span style=color:#e6db74>nosniff</span> <span style=color:#e6db74>always</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>X-XSS-Protection</span> <span style=color:#e6db74>&#34;1</span>; <span style=color:#66d9ef>mode=block&#34;</span> <span style=color:#e6db74>always</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>add_header</span> <span style=color:#e6db74>Referrer-Policy</span> <span style=color:#e6db74>&#34;strict-origin-when-cross-origin&#34;</span> <span style=color:#e6db74>always</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 隐藏服务器信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>server_tokens</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>more_clear_headers</span> <span style=color:#e6db74>Server</span>;
</span></span></code></pre></div><h3 id=133-监控和告警>13.3 监控和告警<a hidden class=anchor aria-hidden=true href=#133-监控和告警>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># nginx_monitor.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查nginx状态</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! systemctl is-active --quiet nginx; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Nginx is down!&#34;</span> | mail -s <span style=color:#e6db74>&#34;Nginx Alert&#34;</span> admin@example.com
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查错误日志</span>
</span></span><span style=display:flex><span>error_count<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>tail -100 /var/log/nginx/error.log | grep <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y/%m/%d&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> | wc -l<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> $error_count -gt <span style=color:#ae81ff>10</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;High error rate: </span>$error_count<span style=color:#e6db74> errors today&#34;</span> | mail -s <span style=color:#e6db74>&#34;Nginx Error Alert&#34;</span> admin@example.com
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://wellzhi.github.io/tags/nginx/>Nginx</a></li></ul></footer><div class=comments-section><div class=comments-header><h3 class=comments-title><svg class="comments-icon" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
评论区</h3><div class=comments-divider></div></div><div id=twikoo-loading class=twikoo-loading><div class=loading-spinner></div><p>评论加载中...</p></div><div id=twikoo class=twikoo-container></div><div id=twikoo-error class=twikoo-error style=display:none><div class=error-content><svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p>评论加载失败，请刷新页面重试</p></div></div></div><style>.comments-section{margin:3rem 0 2rem;padding:0;max-width:100%}.comments-header{margin-bottom:2rem}.comments-title{display:flex;align-items:center;gap:.5rem;font-size:1.5rem;font-weight:600;color:var(--primary,#1a1a1a);margin:0 0 1rem}.comments-icon{width:1.5rem;height:1.5rem;color:var(--theme,#007acc)}.comments-divider{height:2px;background:linear-gradient(90deg,var(--theme,#007acc) 0%,transparent 100%);border-radius:1px;width:60px}.twikoo-container{background:var(--code-bg,#f8f9fa);border-radius:12px;padding:1.5rem;border:1px solid var(--border,#e1e5e9);transition:all .3s ease;min-height:200px}.twikoo-container:hover{border-color:var(--theme,#007acc);box-shadow:0 4px 12px rgba(0,122,204,.1)}.twikoo-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 1rem;color:var(--secondary,#666)}.loading-spinner{width:32px;height:32px;border:3px solid var(--border,#e1e5e9);border-top:3px solid var(--theme,#007acc);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.twikoo-error{text-align:center;padding:2rem;color:var(--secondary,#666)}.error-content{display:flex;flex-direction:column;align-items:center;gap:1rem}.error-icon{width:2rem;height:2rem;color:#dc3545}@media(prefers-color-scheme:dark){.comments-title{color:var(--primary,#ffffff)}.twikoo-container{background:var(--code-bg,#2d3748);border-color:var(--border,#4a5568)}}@media(max-width:768px){.comments-section{margin:2rem 0 1rem}.twikoo-container{padding:1rem;border-radius:8px}.comments-title{font-size:1.25rem}}</style><script src=https://cdn.staticfile.org/twikoo/1.6.16/twikoo.all.min.js></script><script>(function(){const e=document.getElementById("twikoo-loading"),t=document.getElementById("twikoo-error"),n=document.getElementById("twikoo");twikoo.init({envId:"https://twikoo-vercel-navy.vercel.app/",el:"#twikoo",onCommentLoaded:function(){e&&(e.style.display="none")}}).then(function(){e&&(e.style.display="none")}).catch(function(n){console.error("Twikoo 初始化失败:",n),e&&(e.style.display="none"),t&&(t.style.display="block")}),setTimeout(function(){e&&e.style.display!=="none"&&(e.style.display="none",t&&(t.style.display="block"))},5e3)})()</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://wellzhi.github.io/>wellzhi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),theme=""):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),theme="dark"),mermaidTextContents.forEach((e,t)=>{document.getElementsByClassName("language-mermaid")[t].removeAttribute("data-processed"),document.getElementsByClassName("language-mermaid")[t].innerHTML=e}),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>localStorage.getItem("pref-theme")=="dark"?theme="dark":theme="",mermaidTextContents=Array.from(document.getElementsByClassName("language-mermaid")).map(e=>e.innerHTML),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")</script></body></html>