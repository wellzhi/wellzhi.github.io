<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Elasticsearch常用命令与实战教程 | wellzhi</title>
<meta name=keywords content="Elasticsearch,数据库,Docker,命令,搜索引擎,分布式"><meta name=description content="Elasticsearch 是一个开源的分布式搜索和分析引擎，它被广泛用于构建实时搜索应用程序。本文详细介绍了Elasticsearch的常用命令，包括索引操作、文档操作、查询操作、聚合操作以及Docker容器管理等实用技巧。"><meta name=author content="wellzhi"><link rel=canonical href=https://wellzhi.github.io/posts/tech/2013-08-05_elasticsearch/><link crossorigin=anonymous href=/assets/css/stylesheet.b54291e20a5b433add2181af00208e3e72d99f37b405cd9f3ff373c992518ba6.css integrity="sha256-tUKR4gpbQzrdIYGvACCOPnLZnze0Bc2fP/NzyZJRi6Y=" rel="preload stylesheet" as=style><script crossorigin=anonymous src=/assets/js/mermaid.min.af2e2ae7d64e037e8a582c3ba35b128209a6f8350c3825cda07833979e0d827c.js></script><link rel=icon href=https://wellzhi.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://wellzhi.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wellzhi.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wellzhi.github.io/apple-touch-icon.png><link rel=mask-icon href=https://wellzhi.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wellzhi.github.io/posts/tech/2013-08-05_elasticsearch/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wellzhi.github.io/posts/tech/2013-08-05_elasticsearch/"><meta property="og:site_name" content="wellzhi"><meta property="og:title" content="Elasticsearch常用命令与实战教程"><meta property="og:description" content="Elasticsearch 是一个开源的分布式搜索和分析引擎，它被广泛用于构建实时搜索应用程序。本文详细介绍了Elasticsearch的常用命令，包括索引操作、文档操作、查询操作、聚合操作以及Docker容器管理等实用技巧。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-08-05T00:00:00+08:00"><meta property="article:modified_time" content="2013-08-05T00:00:00+08:00"><meta property="article:tag" content="Elasticsearch"><meta property="article:tag" content="数据库"><meta property="article:tag" content="Docker"><meta property="article:tag" content="命令"><meta property="article:tag" content="搜索引擎"><meta property="article:tag" content="分布式"><meta name=twitter:card content="summary"><meta name=twitter:title content="Elasticsearch常用命令与实战教程"><meta name=twitter:description content="Elasticsearch 是一个开源的分布式搜索和分析引擎，它被广泛用于构建实时搜索应用程序。本文详细介绍了Elasticsearch的常用命令，包括索引操作、文档操作、查询操作、聚合操作以及Docker容器管理等实用技巧。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wellzhi.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Tech","item":"https://wellzhi.github.io/posts/tech/"},{"@type":"ListItem","position":3,"name":"Elasticsearch常用命令与实战教程","item":"https://wellzhi.github.io/posts/tech/2013-08-05_elasticsearch/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Elasticsearch常用命令与实战教程","name":"Elasticsearch常用命令与实战教程","description":"Elasticsearch 是一个开源的分布式搜索和分析引擎，它被广泛用于构建实时搜索应用程序。本文详细介绍了Elasticsearch的常用命令，包括索引操作、文档操作、查询操作、聚合操作以及Docker容器管理等实用技巧。","keywords":["Elasticsearch","数据库","Docker","命令","搜索引擎","分布式"],"articleBody":"1. 简介 Elasticsearch是一个基于Apache Lucene的开源分布式搜索和分析引擎，它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。\n1.1 核心概念 索引(Index): 类似于关系数据库中的数据库 类型(Type): 类似于关系数据库中的表（ES 7.x后已废弃） 文档(Document): 类似于关系数据库中的行 字段(Field): 类似于关系数据库中的列 映射(Mapping): 类似于关系数据库中的表结构 分片(Shard): 索引的物理分割 副本(Replica): 分片的备份 2. 连接和基本操作 2.1 连接Elasticsearch # 检查集群健康状态 curl -X GET \"localhost:9200/_cluster/health?pretty\" # 查看集群信息 curl -X GET \"localhost:9200/\" # 查看节点信息 curl -X GET \"localhost:9200/_nodes?pretty\" 2.2 基本配置查看 # 查看集群设置 curl -X GET \"localhost:9200/_cluster/settings?pretty\" # 查看所有索引 curl -X GET \"localhost:9200/_cat/indices?v\" # 查看分片信息 curl -X GET \"localhost:9200/_cat/shards?v\" 3. 索引操作 3.1 创建索引 # 创建简单索引 curl -X PUT \"localhost:9200/my_index\" # 创建带设置的索引 curl -X PUT \"localhost:9200/my_index\" -H 'Content-Type: application/json' -d' { \"settings\": { \"number_of_shards\": 3, \"number_of_replicas\": 1 } }' # 创建带映射的索引 curl -X PUT \"localhost:9200/products\" -H 'Content-Type: application/json' -d' { \"settings\": { \"number_of_shards\": 1, \"number_of_replicas\": 0 }, \"mappings\": { \"properties\": { \"name\": { \"type\": \"text\", \"analyzer\": \"standard\" }, \"price\": { \"type\": \"double\" }, \"description\": { \"type\": \"text\" }, \"category\": { \"type\": \"keyword\" }, \"created_at\": { \"type\": \"date\" } } } }' 3.2 查看索引信息 # 查看索引映射 curl -X GET \"localhost:9200/products/_mapping?pretty\" # 查看索引设置 curl -X GET \"localhost:9200/products/_settings?pretty\" # 查看索引统计信息 curl -X GET \"localhost:9200/products/_stats?pretty\" 3.3 修改索引 # 更新索引设置 curl -X PUT \"localhost:9200/products/_settings\" -H 'Content-Type: application/json' -d' { \"number_of_replicas\": 1 }' # 添加字段映射 curl -X PUT \"localhost:9200/products/_mapping\" -H 'Content-Type: application/json' -d' { \"properties\": { \"tags\": { \"type\": \"keyword\" } } }' 3.4 删除索引 # 删除单个索引 curl -X DELETE \"localhost:9200/my_index\" # 删除多个索引 curl -X DELETE \"localhost:9200/index1,index2\" # 使用通配符删除索引 curl -X DELETE \"localhost:9200/log-*\" 4. 文档操作 4.1 添加文档 # 指定ID添加文档 curl -X PUT \"localhost:9200/products/_doc/1\" -H 'Content-Type: application/json' -d' { \"name\": \"iPhone 13\", \"price\": 999.99, \"description\": \"Latest iPhone model\", \"category\": \"electronics\", \"created_at\": \"2023-01-01T00:00:00Z\" }' # 自动生成ID添加文档 curl -X POST \"localhost:9200/products/_doc\" -H 'Content-Type: application/json' -d' { \"name\": \"Samsung Galaxy S21\", \"price\": 799.99, \"description\": \"Android smartphone\", \"category\": \"electronics\", \"created_at\": \"2023-01-02T00:00:00Z\" }' # 批量添加文档 curl -X POST \"localhost:9200/_bulk\" -H 'Content-Type: application/json' -d' {\"index\":{\"_index\":\"products\",\"_id\":\"3\"}} {\"name\":\"MacBook Pro\",\"price\":1999.99,\"description\":\"Professional laptop\",\"category\":\"computers\",\"created_at\":\"2023-01-03T00:00:00Z\"} {\"index\":{\"_index\":\"products\",\"_id\":\"4\"}} {\"name\":\"iPad Air\",\"price\":599.99,\"description\":\"Tablet device\",\"category\":\"electronics\",\"created_at\":\"2023-01-04T00:00:00Z\"} ' 4.2 查询文档 # 根据ID查询文档 curl -X GET \"localhost:9200/products/_doc/1?pretty\" # 查询所有文档 curl -X GET \"localhost:9200/products/_search?pretty\" # 简单查询 curl -X GET \"localhost:9200/products/_search?q=iPhone\u0026pretty\" # 结构化查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match\": { \"name\": \"iPhone\" } } }' 4.3 更新文档 # 完整更新文档 curl -X PUT \"localhost:9200/products/_doc/1\" -H 'Content-Type: application/json' -d' { \"name\": \"iPhone 13 Pro\", \"price\": 1099.99, \"description\": \"Professional iPhone model\", \"category\": \"electronics\", \"created_at\": \"2023-01-01T00:00:00Z\" }' # 部分更新文档 curl -X POST \"localhost:9200/products/_update/1\" -H 'Content-Type: application/json' -d' { \"doc\": { \"price\": 1199.99 } }' # 使用脚本更新 curl -X POST \"localhost:9200/products/_update/1\" -H 'Content-Type: application/json' -d' { \"script\": { \"source\": \"ctx._source.price += params.increment\", \"params\": { \"increment\": 100 } } }' 4.4 删除文档 # 根据ID删除文档 curl -X DELETE \"localhost:9200/products/_doc/1\" # 根据查询删除文档 curl -X POST \"localhost:9200/products/_delete_by_query\" -H 'Content-Type: application/json' -d' { \"query\": { \"match\": { \"category\": \"electronics\" } } }' 5. 高级查询操作 5.1 基本查询 # Match查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match\": { \"description\": \"smartphone\" } } }' # Term查询（精确匹配） curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"term\": { \"category\": \"electronics\" } } }' # Range查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"range\": { \"price\": { \"gte\": 500, \"lte\": 1000 } } } }' 5.2 复合查询 # Bool查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"bool\": { \"must\": [ {\"match\": {\"category\": \"electronics\"}} ], \"filter\": [ {\"range\": {\"price\": {\"gte\": 500}}} ], \"must_not\": [ {\"match\": {\"name\": \"Samsung\"}} ] } } }' # Multi-match查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"multi_match\": { \"query\": \"iPhone\", \"fields\": [\"name\", \"description\"] } } }' 5.3 排序和分页 # 排序查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match_all\": {} }, \"sort\": [ {\"price\": {\"order\": \"desc\"}}, {\"created_at\": {\"order\": \"asc\"}} ] }' # 分页查询 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match_all\": {} }, \"from\": 0, \"size\": 10 }' 5.4 字段过滤 # 指定返回字段 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match_all\": {} }, \"_source\": [\"name\", \"price\"] }' # 排除字段 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"query\": { \"match_all\": {} }, \"_source\": { \"excludes\": [\"description\"] } }' 6. 聚合操作 6.1 指标聚合 # 平均值聚合 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"size\": 0, \"aggs\": { \"avg_price\": { \"avg\": { \"field\": \"price\" } } } }' # 多个指标聚合 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"size\": 0, \"aggs\": { \"price_stats\": { \"stats\": { \"field\": \"price\" } } } }' 6.2 桶聚合 # Terms聚合（分组） curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"size\": 0, \"aggs\": { \"categories\": { \"terms\": { \"field\": \"category\" } } } }' # 日期直方图聚合 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"size\": 0, \"aggs\": { \"sales_over_time\": { \"date_histogram\": { \"field\": \"created_at\", \"calendar_interval\": \"month\" } } } }' 6.3 嵌套聚合 # 分组后计算平均值 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"size\": 0, \"aggs\": { \"categories\": { \"terms\": { \"field\": \"category\" }, \"aggs\": { \"avg_price\": { \"avg\": { \"field\": \"price\" } } } } } }' 7. 索引模板和别名 7.1 索引模板 # 创建索引模板 curl -X PUT \"localhost:9200/_template/product_template\" -H 'Content-Type: application/json' -d' { \"index_patterns\": [\"product-*\"], \"settings\": { \"number_of_shards\": 1, \"number_of_replicas\": 0 }, \"mappings\": { \"properties\": { \"name\": {\"type\": \"text\"}, \"price\": {\"type\": \"double\"}, \"category\": {\"type\": \"keyword\"} } } }' # 查看模板 curl -X GET \"localhost:9200/_template/product_template?pretty\" # 删除模板 curl -X DELETE \"localhost:9200/_template/product_template\" 7.2 索引别名 # 创建别名 curl -X POST \"localhost:9200/_aliases\" -H 'Content-Type: application/json' -d' { \"actions\": [ { \"add\": { \"index\": \"products\", \"alias\": \"current_products\" } } ] }' # 查看别名 curl -X GET \"localhost:9200/_alias?pretty\" # 删除别名 curl -X POST \"localhost:9200/_aliases\" -H 'Content-Type: application/json' -d' { \"actions\": [ { \"remove\": { \"index\": \"products\", \"alias\": \"current_products\" } } ] }' 8. 集群管理 8.1 集群健康和状态 # 查看集群健康状态 curl -X GET \"localhost:9200/_cluster/health?pretty\" # 查看集群状态 curl -X GET \"localhost:9200/_cluster/state?pretty\" # 查看集群统计信息 curl -X GET \"localhost:9200/_cluster/stats?pretty\" # 查看待处理任务 curl -X GET \"localhost:9200/_cluster/pending_tasks?pretty\" 8.2 节点管理 # 查看节点信息 curl -X GET \"localhost:9200/_nodes?pretty\" # 查看节点统计信息 curl -X GET \"localhost:9200/_nodes/stats?pretty\" # 查看特定节点信息 curl -X GET \"localhost:9200/_nodes/node1?pretty\" 8.3 分片管理 # 查看分片分配 curl -X GET \"localhost:9200/_cat/allocation?v\" # 手动分配分片 curl -X POST \"localhost:9200/_cluster/reroute\" -H 'Content-Type: application/json' -d' { \"commands\": [ { \"move\": { \"index\": \"products\", \"shard\": 0, \"from_node\": \"node1\", \"to_node\": \"node2\" } } ] }' 9. Docker容器管理 9.1 单节点Elasticsearch # 运行单节点Elasticsearch docker run -d \\ --name elasticsearch \\ -p 9200:9200 \\ -p 9300:9300 \\ -e \"discovery.type=single-node\" \\ -e \"ES_JAVA_OPTS=-Xms512m -Xmx512m\" \\ elasticsearch:8.11.0 # 查看容器日志 docker logs elasticsearch # 进入容器 docker exec -it elasticsearch bash 9.2 Docker Compose集群 # docker-compose.yml version: '3.8' services: es01: image: elasticsearch:8.11.0 container_name: es01 environment: - node.name=es01 - cluster.name=es-docker-cluster - discovery.seed_hosts=es02,es03 - cluster.initial_master_nodes=es01,es02,es03 - bootstrap.memory_lock=true - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\" - xpack.security.enabled=false ulimits: memlock: soft: -1 hard: -1 volumes: - data01:/usr/share/elasticsearch/data ports: - 9200:9200 networks: - elastic es02: image: elasticsearch:8.11.0 container_name: es02 environment: - node.name=es02 - cluster.name=es-docker-cluster - discovery.seed_hosts=es01,es03 - cluster.initial_master_nodes=es01,es02,es03 - bootstrap.memory_lock=true - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\" - xpack.security.enabled=false ulimits: memlock: soft: -1 hard: -1 volumes: - data02:/usr/share/elasticsearch/data networks: - elastic es03: image: elasticsearch:8.11.0 container_name: es03 environment: - node.name=es03 - cluster.name=es-docker-cluster - discovery.seed_hosts=es01,es02 - cluster.initial_master_nodes=es01,es02,es03 - bootstrap.memory_lock=true - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\" - xpack.security.enabled=false ulimits: memlock: soft: -1 hard: -1 volumes: - data03:/usr/share/elasticsearch/data networks: - elastic kibana: image: kibana:8.11.0 container_name: kibana ports: - 5601:5601 environment: ELASTICSEARCH_URL: http://es01:9200 ELASTICSEARCH_HOSTS: '[\"http://es01:9200\",\"http://es02:9200\",\"http://es03:9200\"]' networks: - elastic volumes: data01: driver: local data02: driver: local data03: driver: local networks: elastic: driver: bridge # 启动集群 docker-compose up -d # 查看集群状态 docker-compose ps # 停止集群 docker-compose down # 停止并删除数据 docker-compose down -v 9.3 容器管理命令 # 查看Elasticsearch容器状态 docker ps | grep elasticsearch # 重启容器 docker restart elasticsearch # 查看容器资源使用 docker stats elasticsearch # 备份数据 docker exec elasticsearch curl -X PUT \"localhost:9200/_snapshot/my_backup\" -H 'Content-Type: application/json' -d' { \"type\": \"fs\", \"settings\": { \"location\": \"/usr/share/elasticsearch/backup\" } }' # 创建快照 docker exec elasticsearch curl -X PUT \"localhost:9200/_snapshot/my_backup/snapshot_1?wait_for_completion=true\" 10. 性能优化和监控 10.1 性能监控 # 查看索引性能统计 curl -X GET \"localhost:9200/_stats?pretty\" # 查看慢查询日志 curl -X GET \"localhost:9200/_nodes/stats/indices/search?pretty\" # 查看JVM信息 curl -X GET \"localhost:9200/_nodes/stats/jvm?pretty\" # 查看线程池信息 curl -X GET \"localhost:9200/_nodes/stats/thread_pool?pretty\" 10.2 性能优化设置 # 设置刷新间隔 curl -X PUT \"localhost:9200/products/_settings\" -H 'Content-Type: application/json' -d' { \"refresh_interval\": \"30s\" }' # 设置副本数量 curl -X PUT \"localhost:9200/products/_settings\" -H 'Content-Type: application/json' -d' { \"number_of_replicas\": 0 }' # 禁用动态映射 curl -X PUT \"localhost:9200/products/_mapping\" -H 'Content-Type: application/json' -d' { \"dynamic\": false }' 10.3 缓存管理 # 清除缓存 curl -X POST \"localhost:9200/_cache/clear\" # 清除特定索引缓存 curl -X POST \"localhost:9200/products/_cache/clear\" # 查看缓存统计 curl -X GET \"localhost:9200/_stats/indices/query_cache,request_cache?pretty\" 11. 数据备份和恢复 11.1 快照备份 # 创建快照仓库 curl -X PUT \"localhost:9200/_snapshot/my_backup\" -H 'Content-Type: application/json' -d' { \"type\": \"fs\", \"settings\": { \"location\": \"/path/to/backup\" } }' # 创建快照 curl -X PUT \"localhost:9200/_snapshot/my_backup/snapshot_1\" -H 'Content-Type: application/json' -d' { \"indices\": \"products\", \"ignore_unavailable\": true, \"include_global_state\": false }' # 查看快照状态 curl -X GET \"localhost:9200/_snapshot/my_backup/snapshot_1?pretty\" # 恢复快照 curl -X POST \"localhost:9200/_snapshot/my_backup/snapshot_1/_restore\" -H 'Content-Type: application/json' -d' { \"indices\": \"products\", \"ignore_unavailable\": true, \"include_global_state\": false, \"rename_pattern\": \"products\", \"rename_replacement\": \"restored_products\" }' 11.2 数据导入导出 # 使用elasticdump导出数据 npm install -g elasticdump elasticdump --input=http://localhost:9200/products --output=products.json --type=data # 导入数据 elasticdump --input=products.json --output=http://localhost:9200/products --type=data # 导出映射 elasticdump --input=http://localhost:9200/products --output=products_mapping.json --type=mapping 12. 安全配置 12.1 基本安全设置 # 启用安全功能（需要在elasticsearch.yml中配置） # xpack.security.enabled: true # 设置用户密码 curl -X POST \"localhost:9200/_security/user/elastic/_password\" -H 'Content-Type: application/json' -d' { \"password\": \"new_password\" }' # 创建用户 curl -X POST \"localhost:9200/_security/user/myuser\" -H 'Content-Type: application/json' -d' { \"password\": \"mypassword\", \"roles\": [\"kibana_user\", \"monitoring_user\"], \"full_name\": \"My User\", \"email\": \"myuser@example.com\" }' 12.2 角色和权限 # 创建角色 curl -X POST \"localhost:9200/_security/role/my_role\" -H 'Content-Type: application/json' -d' { \"cluster\": [\"monitor\"], \"indices\": [ { \"names\": [\"products*\"], \"privileges\": [\"read\", \"write\"] } ] }' # 查看用户权限 curl -X GET \"localhost:9200/_security/user/myuser?pretty\" 13. 常用工具和技巧 13.1 Kibana集成 # Kibana Dev Tools中的常用命令 GET /_cluster/health GET /products/_search POST /products/_doc { \"name\": \"New Product\", \"price\": 99.99 } 13.2 批量操作技巧 # 批量索引优化 curl -X POST \"localhost:9200/_bulk\" -H 'Content-Type: application/json' --data-binary @bulk_data.json # 批量更新 curl -X POST \"localhost:9200/products/_update_by_query\" -H 'Content-Type: application/json' -d' { \"script\": { \"source\": \"ctx._source.price = ctx._source.price * 1.1\" }, \"query\": { \"term\": { \"category\": \"electronics\" } } }' 13.3 调试和故障排除 # 查看慢查询 curl -X GET \"localhost:9200/_nodes/stats/indices/search?pretty\" | grep slow # 分析查询性能 curl -X GET \"localhost:9200/products/_search\" -H 'Content-Type: application/json' -d' { \"profile\": true, \"query\": { \"match\": { \"name\": \"iPhone\" } } }' # 验证查询 curl -X GET \"localhost:9200/products/_validate/query?explain\" -H 'Content-Type: application/json' -d' { \"query\": { \"match\": { \"name\": \"iPhone\" } } }' 13.4 实用脚本 #!/bin/bash # 健康检查脚本 check_es_health() { local health=$(curl -s \"localhost:9200/_cluster/health\" | jq -r '.status') if [ \"$health\" = \"green\" ]; then echo \"Elasticsearch cluster is healthy\" elif [ \"$health\" = \"yellow\" ]; then echo \"Elasticsearch cluster has warnings\" else echo \"Elasticsearch cluster is unhealthy\" fi } # 索引大小监控 check_index_size() { curl -s \"localhost:9200/_cat/indices?v\u0026h=index,store.size\u0026s=store.size:desc\" } # 执行检查 check_es_health check_index_size 14. 最佳实践 14.1 索引设计 合理设置分片数量：小索引使用1个分片，大索引根据数据量和查询需求设置 避免过多的字段：每个文档的字段数量建议不超过1000个 使用合适的数据类型：避免使用text类型存储不需要全文搜索的数据 设置合理的映射：禁用不需要的功能如_all字段 14.2 查询优化 使用filter而不是query进行精确匹配 避免深度分页，使用scroll API处理大量数据 合理使用缓存：query cache和request cache 避免使用通配符开头的查询 14.3 集群管理 定期监控集群健康状态 设置合理的堆内存大小（不超过32GB） 使用SSD存储提高性能 定期备份重要数据 监控磁盘使用率，避免磁盘满载 14.4 安全建议 启用身份验证和授权 使用HTTPS加密传输 定期更新Elasticsearch版本 限制网络访问，不要将Elasticsearch直接暴露到公网 使用专用用户运行Elasticsearch服务 ","wordCount":"1708","inLanguage":"en","datePublished":"2013-08-05T00:00:00+08:00","dateModified":"2013-08-05T00:00:00+08:00","author":[{"@type":"Person","name":"wellzhi"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://wellzhi.github.io/posts/tech/2013-08-05_elasticsearch/"},"publisher":{"@type":"Organization","name":"wellzhi","logo":{"@type":"ImageObject","url":"https://wellzhi.github.io/favicon.ico"}}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wellzhi.github.io/ accesskey=h title="wellzhi (Alt + H)">wellzhi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wellzhi.github.io/ title=Home><span>Home</span></a></li><li><a href=https://wellzhi.github.io/posts/ title=Post><span>Post</span></a></li><li><a href=https://wellzhi.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://wellzhi.github.io/tags title=Tags><span>Tags</span></a></li><li><a href=https://wellzhi.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://wellzhi.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wellzhi.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://wellzhi.github.io/posts/tech/>Tech</a></div><h1 class="post-title entry-hint-parent">Elasticsearch常用命令与实战教程</h1></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e7%ae%80%e4%bb%8b aria-label="1. 简介">1. 简介</a><ul><li><a href=#11-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5 aria-label="1.1 核心概念">1.1 核心概念</a></li></ul></li><li><a href=#2-%e8%bf%9e%e6%8e%a5%e5%92%8c%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c aria-label="2. 连接和基本操作">2. 连接和基本操作</a><ul><li><a href=#21-%e8%bf%9e%e6%8e%a5elasticsearch aria-label="2.1 连接Elasticsearch">2.1 连接Elasticsearch</a></li><li><a href=#22-%e5%9f%ba%e6%9c%ac%e9%85%8d%e7%bd%ae%e6%9f%a5%e7%9c%8b aria-label="2.2 基本配置查看">2.2 基本配置查看</a></li></ul></li><li><a href=#3-%e7%b4%a2%e5%bc%95%e6%93%8d%e4%bd%9c aria-label="3. 索引操作">3. 索引操作</a><ul><li><a href=#31-%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95 aria-label="3.1 创建索引">3.1 创建索引</a></li><li><a href=#32-%e6%9f%a5%e7%9c%8b%e7%b4%a2%e5%bc%95%e4%bf%a1%e6%81%af aria-label="3.2 查看索引信息">3.2 查看索引信息</a></li><li><a href=#33-%e4%bf%ae%e6%94%b9%e7%b4%a2%e5%bc%95 aria-label="3.3 修改索引">3.3 修改索引</a></li><li><a href=#34-%e5%88%a0%e9%99%a4%e7%b4%a2%e5%bc%95 aria-label="3.4 删除索引">3.4 删除索引</a></li></ul></li><li><a href=#4-%e6%96%87%e6%a1%a3%e6%93%8d%e4%bd%9c aria-label="4. 文档操作">4. 文档操作</a><ul><li><a href=#41-%e6%b7%bb%e5%8a%a0%e6%96%87%e6%a1%a3 aria-label="4.1 添加文档">4.1 添加文档</a></li><li><a href=#42-%e6%9f%a5%e8%af%a2%e6%96%87%e6%a1%a3 aria-label="4.2 查询文档">4.2 查询文档</a></li><li><a href=#43-%e6%9b%b4%e6%96%b0%e6%96%87%e6%a1%a3 aria-label="4.3 更新文档">4.3 更新文档</a></li><li><a href=#44-%e5%88%a0%e9%99%a4%e6%96%87%e6%a1%a3 aria-label="4.4 删除文档">4.4 删除文档</a></li></ul></li><li><a href=#5-%e9%ab%98%e7%ba%a7%e6%9f%a5%e8%af%a2%e6%93%8d%e4%bd%9c aria-label="5. 高级查询操作">5. 高级查询操作</a><ul><li><a href=#51-%e5%9f%ba%e6%9c%ac%e6%9f%a5%e8%af%a2 aria-label="5.1 基本查询">5.1 基本查询</a></li><li><a href=#52-%e5%a4%8d%e5%90%88%e6%9f%a5%e8%af%a2 aria-label="5.2 复合查询">5.2 复合查询</a></li><li><a href=#53-%e6%8e%92%e5%ba%8f%e5%92%8c%e5%88%86%e9%a1%b5 aria-label="5.3 排序和分页">5.3 排序和分页</a></li><li><a href=#54-%e5%ad%97%e6%ae%b5%e8%bf%87%e6%bb%a4 aria-label="5.4 字段过滤">5.4 字段过滤</a></li></ul></li><li><a href=#6-%e8%81%9a%e5%90%88%e6%93%8d%e4%bd%9c aria-label="6. 聚合操作">6. 聚合操作</a><ul><li><a href=#61-%e6%8c%87%e6%a0%87%e8%81%9a%e5%90%88 aria-label="6.1 指标聚合">6.1 指标聚合</a></li><li><a href=#62-%e6%a1%b6%e8%81%9a%e5%90%88 aria-label="6.2 桶聚合">6.2 桶聚合</a></li><li><a href=#63-%e5%b5%8c%e5%a5%97%e8%81%9a%e5%90%88 aria-label="6.3 嵌套聚合">6.3 嵌套聚合</a></li></ul></li><li><a href=#7-%e7%b4%a2%e5%bc%95%e6%a8%a1%e6%9d%bf%e5%92%8c%e5%88%ab%e5%90%8d aria-label="7. 索引模板和别名">7. 索引模板和别名</a><ul><li><a href=#71-%e7%b4%a2%e5%bc%95%e6%a8%a1%e6%9d%bf aria-label="7.1 索引模板">7.1 索引模板</a></li><li><a href=#72-%e7%b4%a2%e5%bc%95%e5%88%ab%e5%90%8d aria-label="7.2 索引别名">7.2 索引别名</a></li></ul></li><li><a href=#8-%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86 aria-label="8. 集群管理">8. 集群管理</a><ul><li><a href=#81-%e9%9b%86%e7%be%a4%e5%81%a5%e5%ba%b7%e5%92%8c%e7%8a%b6%e6%80%81 aria-label="8.1 集群健康和状态">8.1 集群健康和状态</a></li><li><a href=#82-%e8%8a%82%e7%82%b9%e7%ae%a1%e7%90%86 aria-label="8.2 节点管理">8.2 节点管理</a></li><li><a href=#83-%e5%88%86%e7%89%87%e7%ae%a1%e7%90%86 aria-label="8.3 分片管理">8.3 分片管理</a></li></ul></li><li><a href=#9-docker%e5%ae%b9%e5%99%a8%e7%ae%a1%e7%90%86 aria-label="9. Docker容器管理">9. Docker容器管理</a><ul><li><a href=#91-%e5%8d%95%e8%8a%82%e7%82%b9elasticsearch aria-label="9.1 单节点Elasticsearch">9.1 单节点Elasticsearch</a></li><li><a href=#92-docker-compose%e9%9b%86%e7%be%a4 aria-label="9.2 Docker Compose集群">9.2 Docker Compose集群</a></li><li><a href=#93-%e5%ae%b9%e5%99%a8%e7%ae%a1%e7%90%86%e5%91%bd%e4%bb%a4 aria-label="9.3 容器管理命令">9.3 容器管理命令</a></li></ul></li><li><a href=#10-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e5%92%8c%e7%9b%91%e6%8e%a7 aria-label="10. 性能优化和监控">10. 性能优化和监控</a><ul><li><a href=#101-%e6%80%a7%e8%83%bd%e7%9b%91%e6%8e%a7 aria-label="10.1 性能监控">10.1 性能监控</a></li><li><a href=#102-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e8%ae%be%e7%bd%ae aria-label="10.2 性能优化设置">10.2 性能优化设置</a></li><li><a href=#103-%e7%bc%93%e5%ad%98%e7%ae%a1%e7%90%86 aria-label="10.3 缓存管理">10.3 缓存管理</a></li></ul></li><li><a href=#11-%e6%95%b0%e6%8d%ae%e5%a4%87%e4%bb%bd%e5%92%8c%e6%81%a2%e5%a4%8d aria-label="11. 数据备份和恢复">11. 数据备份和恢复</a><ul><li><a href=#111-%e5%bf%ab%e7%85%a7%e5%a4%87%e4%bb%bd aria-label="11.1 快照备份">11.1 快照备份</a></li><li><a href=#112-%e6%95%b0%e6%8d%ae%e5%af%bc%e5%85%a5%e5%af%bc%e5%87%ba aria-label="11.2 数据导入导出">11.2 数据导入导出</a></li></ul></li><li><a href=#12-%e5%ae%89%e5%85%a8%e9%85%8d%e7%bd%ae aria-label="12. 安全配置">12. 安全配置</a><ul><li><a href=#121-%e5%9f%ba%e6%9c%ac%e5%ae%89%e5%85%a8%e8%ae%be%e7%bd%ae aria-label="12.1 基本安全设置">12.1 基本安全设置</a></li><li><a href=#122-%e8%a7%92%e8%89%b2%e5%92%8c%e6%9d%83%e9%99%90 aria-label="12.2 角色和权限">12.2 角色和权限</a></li></ul></li><li><a href=#13-%e5%b8%b8%e7%94%a8%e5%b7%a5%e5%85%b7%e5%92%8c%e6%8a%80%e5%b7%a7 aria-label="13. 常用工具和技巧">13. 常用工具和技巧</a><ul><li><a href=#131-kibana%e9%9b%86%e6%88%90 aria-label="13.1 Kibana集成">13.1 Kibana集成</a></li><li><a href=#132-%e6%89%b9%e9%87%8f%e6%93%8d%e4%bd%9c%e6%8a%80%e5%b7%a7 aria-label="13.2 批量操作技巧">13.2 批量操作技巧</a></li><li><a href=#133-%e8%b0%83%e8%af%95%e5%92%8c%e6%95%85%e9%9a%9c%e6%8e%92%e9%99%a4 aria-label="13.3 调试和故障排除">13.3 调试和故障排除</a></li><li><a href=#134-%e5%ae%9e%e7%94%a8%e8%84%9a%e6%9c%ac aria-label="13.4 实用脚本">13.4 实用脚本</a></li></ul></li><li><a href=#14-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="14. 最佳实践">14. 最佳实践</a><ul><li><a href=#141-%e7%b4%a2%e5%bc%95%e8%ae%be%e8%ae%a1 aria-label="14.1 索引设计">14.1 索引设计</a></li><li><a href=#142-%e6%9f%a5%e8%af%a2%e4%bc%98%e5%8c%96 aria-label="14.2 查询优化">14.2 查询优化</a></li><li><a href=#143-%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86 aria-label="14.3 集群管理">14.3 集群管理</a></li><li><a href=#144-%e5%ae%89%e5%85%a8%e5%bb%ba%e8%ae%ae aria-label="14.4 安全建议">14.4 安全建议</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=1-简介>1. 简介<a hidden class=anchor aria-hidden=true href=#1-简介>#</a></h2><p>Elasticsearch是一个基于Apache Lucene的开源分布式搜索和分析引擎，它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。</p><h3 id=11-核心概念>1.1 核心概念<a hidden class=anchor aria-hidden=true href=#11-核心概念>#</a></h3><ul><li><strong>索引(Index)</strong>: 类似于关系数据库中的数据库</li><li><strong>类型(Type)</strong>: 类似于关系数据库中的表（ES 7.x后已废弃）</li><li><strong>文档(Document)</strong>: 类似于关系数据库中的行</li><li><strong>字段(Field)</strong>: 类似于关系数据库中的列</li><li><strong>映射(Mapping)</strong>: 类似于关系数据库中的表结构</li><li><strong>分片(Shard)</strong>: 索引的物理分割</li><li><strong>副本(Replica)</strong>: 分片的备份</li></ul><h2 id=2-连接和基本操作>2. 连接和基本操作<a hidden class=anchor aria-hidden=true href=#2-连接和基本操作>#</a></h2><h3 id=21-连接elasticsearch>2.1 连接Elasticsearch<a hidden class=anchor aria-hidden=true href=#21-连接elasticsearch>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 检查集群健康状态</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/health?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes?pretty&#34;</span>
</span></span></code></pre></div><h3 id=22-基本配置查看>2.2 基本配置查看<a hidden class=anchor aria-hidden=true href=#22-基本配置查看>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看集群设置</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/settings?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看所有索引</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cat/indices?v&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看分片信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cat/shards?v&#34;</span>
</span></span></code></pre></div><h2 id=3-索引操作>3. 索引操作<a hidden class=anchor aria-hidden=true href=#3-索引操作>#</a></h2><h3 id=31-创建索引>3.1 创建索引<a hidden class=anchor aria-hidden=true href=#31-创建索引>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建简单索引</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/my_index&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建带设置的索引</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/my_index&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_shards&#34;: 3,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_replicas&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建带映射的索引</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_shards&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_replicas&#34;: 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;mappings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;properties&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;type&#34;: &#34;text&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;analyzer&#34;: &#34;standard&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;price&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;type&#34;: &#34;double&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;description&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;type&#34;: &#34;text&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;category&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;created_at&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;type&#34;: &#34;date&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=32-查看索引信息>3.2 查看索引信息<a hidden class=anchor aria-hidden=true href=#32-查看索引信息>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看索引映射</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_mapping?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看索引设置</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_settings?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看索引统计信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_stats?pretty&#34;</span>
</span></span></code></pre></div><h3 id=33-修改索引>3.3 修改索引<a hidden class=anchor aria-hidden=true href=#33-修改索引>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 更新索引设置</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_settings&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;number_of_replicas&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加字段映射</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_mapping&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;properties&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;tags&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;type&#34;: &#34;keyword&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=34-删除索引>3.4 删除索引<a hidden class=anchor aria-hidden=true href=#34-删除索引>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 删除单个索引</span>
</span></span><span style=display:flex><span>curl -X DELETE <span style=color:#e6db74>&#34;localhost:9200/my_index&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除多个索引</span>
</span></span><span style=display:flex><span>curl -X DELETE <span style=color:#e6db74>&#34;localhost:9200/index1,index2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用通配符删除索引</span>
</span></span><span style=display:flex><span>curl -X DELETE <span style=color:#e6db74>&#34;localhost:9200/log-*&#34;</span>
</span></span></code></pre></div><h2 id=4-文档操作>4. 文档操作<a hidden class=anchor aria-hidden=true href=#4-文档操作>#</a></h2><h3 id=41-添加文档>4.1 添加文档<a hidden class=anchor aria-hidden=true href=#41-添加文档>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 指定ID添加文档</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_doc/1&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;name&#34;: &#34;iPhone 13&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;price&#34;: 999.99,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;description&#34;: &#34;Latest iPhone model&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;category&#34;: &#34;electronics&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;created_at&#34;: &#34;2023-01-01T00:00:00Z&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 自动生成ID添加文档</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_doc&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;name&#34;: &#34;Samsung Galaxy S21&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;price&#34;: 799.99,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;description&#34;: &#34;Android smartphone&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;category&#34;: &#34;electronics&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;created_at&#34;: &#34;2023-01-02T00:00:00Z&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 批量添加文档</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_bulk&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;index&#34;:{&#34;_index&#34;:&#34;products&#34;,&#34;_id&#34;:&#34;3&#34;}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;name&#34;:&#34;MacBook Pro&#34;,&#34;price&#34;:1999.99,&#34;description&#34;:&#34;Professional laptop&#34;,&#34;category&#34;:&#34;computers&#34;,&#34;created_at&#34;:&#34;2023-01-03T00:00:00Z&#34;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;index&#34;:{&#34;_index&#34;:&#34;products&#34;,&#34;_id&#34;:&#34;4&#34;}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;name&#34;:&#34;iPad Air&#34;,&#34;price&#34;:599.99,&#34;description&#34;:&#34;Tablet device&#34;,&#34;category&#34;:&#34;electronics&#34;,&#34;created_at&#34;:&#34;2023-01-04T00:00:00Z&#34;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span>
</span></span></code></pre></div><h3 id=42-查询文档>4.2 查询文档<a hidden class=anchor aria-hidden=true href=#42-查询文档>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 根据ID查询文档</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_doc/1?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询所有文档</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 简单查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search?q=iPhone&amp;pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 结构化查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: &#34;iPhone&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=43-更新文档>4.3 更新文档<a hidden class=anchor aria-hidden=true href=#43-更新文档>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 完整更新文档</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_doc/1&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;name&#34;: &#34;iPhone 13 Pro&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;price&#34;: 1099.99,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;description&#34;: &#34;Professional iPhone model&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;category&#34;: &#34;electronics&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;created_at&#34;: &#34;2023-01-01T00:00:00Z&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 部分更新文档</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_update/1&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;doc&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;price&#34;: 1199.99
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用脚本更新</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_update/1&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;source&#34;: &#34;ctx._source.price += params.increment&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;params&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;increment&#34;: 100
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=44-删除文档>4.4 删除文档<a hidden class=anchor aria-hidden=true href=#44-删除文档>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 根据ID删除文档</span>
</span></span><span style=display:flex><span>curl -X DELETE <span style=color:#e6db74>&#34;localhost:9200/products/_doc/1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据查询删除文档</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_delete_by_query&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;category&#34;: &#34;electronics&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h2 id=5-高级查询操作>5. 高级查询操作<a hidden class=anchor aria-hidden=true href=#5-高级查询操作>#</a></h2><h3 id=51-基本查询>5.1 基本查询<a hidden class=anchor aria-hidden=true href=#51-基本查询>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Match查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;description&#34;: &#34;smartphone&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Term查询（精确匹配）</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;term&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;category&#34;: &#34;electronics&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Range查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;range&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;price&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;gte&#34;: 500,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;lte&#34;: 1000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=52-复合查询>5.2 复合查询<a hidden class=anchor aria-hidden=true href=#52-复合查询>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Bool查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;bool&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;must&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;match&#34;: {&#34;category&#34;: &#34;electronics&#34;}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;filter&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;range&#34;: {&#34;price&#34;: {&#34;gte&#34;: 500}}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;must_not&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;match&#34;: {&#34;name&#34;: &#34;Samsung&#34;}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Multi-match查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;multi_match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;query&#34;: &#34;iPhone&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;fields&#34;: [&#34;name&#34;, &#34;description&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=53-排序和分页>5.3 排序和分页<a hidden class=anchor aria-hidden=true href=#53-排序和分页>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 排序查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;sort&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {&#34;price&#34;: {&#34;order&#34;: &#34;desc&#34;}},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {&#34;created_at&#34;: {&#34;order&#34;: &#34;asc&#34;}}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分页查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;from&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 10
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=54-字段过滤>5.4 字段过滤<a hidden class=anchor aria-hidden=true href=#54-字段过滤>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 指定返回字段</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;_source&#34;: [&#34;name&#34;, &#34;price&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 排除字段</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match_all&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;_source&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;excludes&#34;: [&#34;description&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h2 id=6-聚合操作>6. 聚合操作<a hidden class=anchor aria-hidden=true href=#6-聚合操作>#</a></h2><h3 id=61-指标聚合>6.1 指标聚合<a hidden class=anchor aria-hidden=true href=#61-指标聚合>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 平均值聚合</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;avg_price&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;avg&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;field&#34;: &#34;price&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 多个指标聚合</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;price_stats&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;stats&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;field&#34;: &#34;price&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=62-桶聚合>6.2 桶聚合<a hidden class=anchor aria-hidden=true href=#62-桶聚合>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Terms聚合（分组）</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;categories&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;terms&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;field&#34;: &#34;category&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 日期直方图聚合</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;sales_over_time&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;date_histogram&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;field&#34;: &#34;created_at&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;calendar_interval&#34;: &#34;month&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=63-嵌套聚合>6.3 嵌套聚合<a hidden class=anchor aria-hidden=true href=#63-嵌套聚合>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 分组后计算平均值</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;size&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;categories&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;terms&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;field&#34;: &#34;category&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;aggs&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;avg_price&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;avg&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;field&#34;: &#34;price&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h2 id=7-索引模板和别名>7. 索引模板和别名<a hidden class=anchor aria-hidden=true href=#7-索引模板和别名>#</a></h2><h3 id=71-索引模板>7.1 索引模板<a hidden class=anchor aria-hidden=true href=#71-索引模板>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建索引模板</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/_template/product_template&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;index_patterns&#34;: [&#34;product-*&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_shards&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;number_of_replicas&#34;: 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;mappings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;properties&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: {&#34;type&#34;: &#34;text&#34;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;price&#34;: {&#34;type&#34;: &#34;double&#34;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;category&#34;: {&#34;type&#34;: &#34;keyword&#34;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看模板</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_template/product_template?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除模板</span>
</span></span><span style=display:flex><span>curl -X DELETE <span style=color:#e6db74>&#34;localhost:9200/_template/product_template&#34;</span>
</span></span></code></pre></div><h3 id=72-索引别名>7.2 索引别名<a hidden class=anchor aria-hidden=true href=#72-索引别名>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建别名</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_aliases&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;actions&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;add&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;index&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;alias&#34;: &#34;current_products&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看别名</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_alias?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除别名</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_aliases&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;actions&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;remove&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;index&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;alias&#34;: &#34;current_products&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h2 id=8-集群管理>8. 集群管理<a hidden class=anchor aria-hidden=true href=#8-集群管理>#</a></h2><h3 id=81-集群健康和状态>8.1 集群健康和状态<a hidden class=anchor aria-hidden=true href=#81-集群健康和状态>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看集群健康状态</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/health?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群状态</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/state?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群统计信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/stats?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看待处理任务</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cluster/pending_tasks?pretty&#34;</span>
</span></span></code></pre></div><h3 id=82-节点管理>8.2 节点管理<a hidden class=anchor aria-hidden=true href=#82-节点管理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看节点信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点统计信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/stats?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看特定节点信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/node1?pretty&#34;</span>
</span></span></code></pre></div><h3 id=83-分片管理>8.3 分片管理<a hidden class=anchor aria-hidden=true href=#83-分片管理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看分片分配</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_cat/allocation?v&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 手动分配分片</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_cluster/reroute&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;commands&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;move&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;index&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;shard&#34;: 0,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;from_node&#34;: &#34;node1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;to_node&#34;: &#34;node2&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h2 id=9-docker容器管理>9. Docker容器管理<a hidden class=anchor aria-hidden=true href=#9-docker容器管理>#</a></h2><h3 id=91-单节点elasticsearch>9.1 单节点Elasticsearch<a hidden class=anchor aria-hidden=true href=#91-单节点elasticsearch>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 运行单节点Elasticsearch</span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --name elasticsearch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 9200:9200 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 9300:9300 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;discovery.type=single-node&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e <span style=color:#e6db74>&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  elasticsearch:8.11.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看容器日志</span>
</span></span><span style=display:flex><span>docker logs elasticsearch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进入容器</span>
</span></span><span style=display:flex><span>docker exec -it elasticsearch bash
</span></span></code></pre></div><h3 id=92-docker-compose集群>9.2 Docker Compose集群<a hidden class=anchor aria-hidden=true href=#92-docker-compose集群>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># docker-compose.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.8&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>es01</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>elasticsearch:8.11.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>es01</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>node.name=es01</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.name=es-docker-cluster</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>discovery.seed_hosts=es02,es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.initial_master_nodes=es01,es02,es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>bootstrap.memory_lock=true</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>xpack.security.enabled=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ulimits</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>memlock</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>soft</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hard</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>data01:/usr/share/elasticsearch/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>9200</span>:<span style=color:#ae81ff>9200</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>elastic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>es02</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>elasticsearch:8.11.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>es02</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>node.name=es02</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.name=es-docker-cluster</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>discovery.seed_hosts=es01,es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.initial_master_nodes=es01,es02,es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>bootstrap.memory_lock=true</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>xpack.security.enabled=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ulimits</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>memlock</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>soft</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hard</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>data02:/usr/share/elasticsearch/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>elastic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>es03</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>elasticsearch:8.11.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>es03</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>node.name=es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.name=es-docker-cluster</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>discovery.seed_hosts=es01,es02</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cluster.initial_master_nodes=es01,es02,es03</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>bootstrap.memory_lock=true</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;ES_JAVA_OPTS=-Xms512m -Xmx512m&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>xpack.security.enabled=false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ulimits</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>memlock</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>soft</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hard</span>: -<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>data03:/usr/share/elasticsearch/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>elastic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>kibana</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>kibana:8.11.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>kibana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5601</span>:<span style=color:#ae81ff>5601</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ELASTICSEARCH_URL</span>: <span style=color:#ae81ff>http://es01:9200</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ELASTICSEARCH_HOSTS</span>: <span style=color:#e6db74>&#39;[&#34;http://es01:9200&#34;,&#34;http://es02:9200&#34;,&#34;http://es03:9200&#34;]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>elastic</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>data01</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>data02</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>data03</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>elastic</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver</span>: <span style=color:#ae81ff>bridge</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 启动集群</span>
</span></span><span style=display:flex><span>docker-compose up -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看集群状态</span>
</span></span><span style=display:flex><span>docker-compose ps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止集群</span>
</span></span><span style=display:flex><span>docker-compose down
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止并删除数据</span>
</span></span><span style=display:flex><span>docker-compose down -v
</span></span></code></pre></div><h3 id=93-容器管理命令>9.3 容器管理命令<a hidden class=anchor aria-hidden=true href=#93-容器管理命令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看Elasticsearch容器状态</span>
</span></span><span style=display:flex><span>docker ps | grep elasticsearch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启容器</span>
</span></span><span style=display:flex><span>docker restart elasticsearch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看容器资源使用</span>
</span></span><span style=display:flex><span>docker stats elasticsearch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 备份数据</span>
</span></span><span style=display:flex><span>docker exec elasticsearch curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;type&#34;: &#34;fs&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;location&#34;: &#34;/usr/share/elasticsearch/backup&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建快照</span>
</span></span><span style=display:flex><span>docker exec elasticsearch curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup/snapshot_1?wait_for_completion=true&#34;</span>
</span></span></code></pre></div><h2 id=10-性能优化和监控>10. 性能优化和监控<a hidden class=anchor aria-hidden=true href=#10-性能优化和监控>#</a></h2><h3 id=101-性能监控>10.1 性能监控<a hidden class=anchor aria-hidden=true href=#101-性能监控>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看索引性能统计</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_stats?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看慢查询日志</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/stats/indices/search?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看JVM信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/stats/jvm?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看线程池信息</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/stats/thread_pool?pretty&#34;</span>
</span></span></code></pre></div><h3 id=102-性能优化设置>10.2 性能优化设置<a hidden class=anchor aria-hidden=true href=#102-性能优化设置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置刷新间隔</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_settings&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;refresh_interval&#34;: &#34;30s&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置副本数量</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_settings&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;number_of_replicas&#34;: 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 禁用动态映射</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/products/_mapping&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;dynamic&#34;: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=103-缓存管理>10.3 缓存管理<a hidden class=anchor aria-hidden=true href=#103-缓存管理>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 清除缓存</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_cache/clear&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 清除特定索引缓存</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_cache/clear&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看缓存统计</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_stats/indices/query_cache,request_cache?pretty&#34;</span>
</span></span></code></pre></div><h2 id=11-数据备份和恢复>11. 数据备份和恢复<a hidden class=anchor aria-hidden=true href=#11-数据备份和恢复>#</a></h2><h3 id=111-快照备份>11.1 快照备份<a hidden class=anchor aria-hidden=true href=#111-快照备份>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建快照仓库</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;type&#34;: &#34;fs&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;settings&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;location&#34;: &#34;/path/to/backup&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建快照</span>
</span></span><span style=display:flex><span>curl -X PUT <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup/snapshot_1&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;indices&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;ignore_unavailable&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;include_global_state&#34;: false
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看快照状态</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup/snapshot_1?pretty&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 恢复快照</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_snapshot/my_backup/snapshot_1/_restore&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;indices&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;ignore_unavailable&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;include_global_state&#34;: false,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;rename_pattern&#34;: &#34;products&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;rename_replacement&#34;: &#34;restored_products&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=112-数据导入导出>11.2 数据导入导出<a hidden class=anchor aria-hidden=true href=#112-数据导入导出>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 使用elasticdump导出数据</span>
</span></span><span style=display:flex><span>npm install -g elasticdump
</span></span><span style=display:flex><span>elasticdump --input<span style=color:#f92672>=</span>http://localhost:9200/products --output<span style=color:#f92672>=</span>products.json --type<span style=color:#f92672>=</span>data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 导入数据</span>
</span></span><span style=display:flex><span>elasticdump --input<span style=color:#f92672>=</span>products.json --output<span style=color:#f92672>=</span>http://localhost:9200/products --type<span style=color:#f92672>=</span>data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 导出映射</span>
</span></span><span style=display:flex><span>elasticdump --input<span style=color:#f92672>=</span>http://localhost:9200/products --output<span style=color:#f92672>=</span>products_mapping.json --type<span style=color:#f92672>=</span>mapping
</span></span></code></pre></div><h2 id=12-安全配置>12. 安全配置<a hidden class=anchor aria-hidden=true href=#12-安全配置>#</a></h2><h3 id=121-基本安全设置>12.1 基本安全设置<a hidden class=anchor aria-hidden=true href=#121-基本安全设置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 启用安全功能（需要在elasticsearch.yml中配置）</span>
</span></span><span style=display:flex><span><span style=color:#75715e># xpack.security.enabled: true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置用户密码</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_security/user/elastic/_password&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;password&#34;: &#34;new_password&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建用户</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_security/user/myuser&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;password&#34;: &#34;mypassword&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;roles&#34;: [&#34;kibana_user&#34;, &#34;monitoring_user&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;full_name&#34;: &#34;My User&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;email&#34;: &#34;myuser@example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=122-角色和权限>12.2 角色和权限<a hidden class=anchor aria-hidden=true href=#122-角色和权限>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 创建角色</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_security/role/my_role&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;cluster&#34;: [&#34;monitor&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;indices&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;names&#34;: [&#34;products*&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;privileges&#34;: [&#34;read&#34;, &#34;write&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看用户权限</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_security/user/myuser?pretty&#34;</span>
</span></span></code></pre></div><h2 id=13-常用工具和技巧>13. 常用工具和技巧<a hidden class=anchor aria-hidden=true href=#13-常用工具和技巧>#</a></h2><h3 id=131-kibana集成>13.1 Kibana集成<a hidden class=anchor aria-hidden=true href=#131-kibana集成>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Kibana Dev Tools中的常用命令</span>
</span></span><span style=display:flex><span>GET /_cluster/health
</span></span><span style=display:flex><span>GET /products/_search
</span></span><span style=display:flex><span>POST /products/_doc
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;New Product&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;price&#34;</span>: 99.99
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=132-批量操作技巧>13.2 批量操作技巧<a hidden class=anchor aria-hidden=true href=#132-批量操作技巧>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 批量索引优化</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/_bulk&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> --data-binary @bulk_data.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 批量更新</span>
</span></span><span style=display:flex><span>curl -X POST <span style=color:#e6db74>&#34;localhost:9200/products/_update_by_query&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;script&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;source&#34;: &#34;ctx._source.price = ctx._source.price * 1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;term&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;category&#34;: &#34;electronics&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=133-调试和故障排除>13.3 调试和故障排除<a hidden class=anchor aria-hidden=true href=#133-调试和故障排除>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 查看慢查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/_nodes/stats/indices/search?pretty&#34;</span> | grep slow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分析查询性能</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_search&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;profile&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: &#34;iPhone&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证查询</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#34;localhost:9200/products/_validate/query?explain&#34;</span> -H <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> -d<span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#34;query&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;match&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;name&#34;: &#34;iPhone&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><h3 id=134-实用脚本>13.4 实用脚本<a hidden class=anchor aria-hidden=true href=#134-实用脚本>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># 健康检查脚本</span>
</span></span><span style=display:flex><span>check_es_health<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    local health<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s <span style=color:#e6db74>&#34;localhost:9200/_cluster/health&#34;</span> | jq -r <span style=color:#e6db74>&#39;.status&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$health<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;green&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Elasticsearch cluster is healthy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$health<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yellow&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Elasticsearch cluster has warnings&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;Elasticsearch cluster is unhealthy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 索引大小监控</span>
</span></span><span style=display:flex><span>check_index_size<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    curl -s <span style=color:#e6db74>&#34;localhost:9200/_cat/indices?v&amp;h=index,store.size&amp;s=store.size:desc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行检查</span>
</span></span><span style=display:flex><span>check_es_health
</span></span><span style=display:flex><span>check_index_size
</span></span></code></pre></div><h2 id=14-最佳实践>14. 最佳实践<a hidden class=anchor aria-hidden=true href=#14-最佳实践>#</a></h2><h3 id=141-索引设计>14.1 索引设计<a hidden class=anchor aria-hidden=true href=#141-索引设计>#</a></h3><ul><li>合理设置分片数量：小索引使用1个分片，大索引根据数据量和查询需求设置</li><li>避免过多的字段：每个文档的字段数量建议不超过1000个</li><li>使用合适的数据类型：避免使用text类型存储不需要全文搜索的数据</li><li>设置合理的映射：禁用不需要的功能如_all字段</li></ul><h3 id=142-查询优化>14.2 查询优化<a hidden class=anchor aria-hidden=true href=#142-查询优化>#</a></h3><ul><li>使用filter而不是query进行精确匹配</li><li>避免深度分页，使用scroll API处理大量数据</li><li>合理使用缓存：query cache和request cache</li><li>避免使用通配符开头的查询</li></ul><h3 id=143-集群管理>14.3 集群管理<a hidden class=anchor aria-hidden=true href=#143-集群管理>#</a></h3><ul><li>定期监控集群健康状态</li><li>设置合理的堆内存大小（不超过32GB）</li><li>使用SSD存储提高性能</li><li>定期备份重要数据</li><li>监控磁盘使用率，避免磁盘满载</li></ul><h3 id=144-安全建议>14.4 安全建议<a hidden class=anchor aria-hidden=true href=#144-安全建议>#</a></h3><ul><li>启用身份验证和授权</li><li>使用HTTPS加密传输</li><li>定期更新Elasticsearch版本</li><li>限制网络访问，不要将Elasticsearch直接暴露到公网</li><li>使用专用用户运行Elasticsearch服务</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://wellzhi.github.io/tags/elasticsearch/>Elasticsearch</a></li><li><a href=https://wellzhi.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a></li><li><a href=https://wellzhi.github.io/tags/docker/>Docker</a></li><li><a href=https://wellzhi.github.io/tags/%E5%91%BD%E4%BB%A4/>命令</a></li><li><a href=https://wellzhi.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/>搜索引擎</a></li><li><a href=https://wellzhi.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/>分布式</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wellzhi.github.io/>wellzhi</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),theme=""):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),theme="dark"),mermaidTextContents.forEach((e,t)=>{document.getElementsByClassName("language-mermaid")[t].removeAttribute("data-processed"),document.getElementsByClassName("language-mermaid")[t].innerHTML=e}),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script>localStorage.getItem("pref-theme")=="dark"?theme="dark":theme="",mermaidTextContents=Array.from(document.getElementsByClassName("language-mermaid")).map(e=>e.innerHTML),mermaid.initialize({theme,startOnLoad:!0}),mermaid.init(void 0,".language-mermaid")</script></body></html>